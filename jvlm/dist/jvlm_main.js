"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var MAP_OP_SHOW_SEL=0,VLM2Prefs=new PrefMgr;function LoadLocalPref(e,t){var a=store.get(e);return void 0===a&&(a=t),a}function PrefMgr(){this.MapPrefs=new MapPrefs,this.CurTheme="bleu-noir",this.MapPrefs=new MapPrefs,this.Init=function(){this.MapPrefs.Load(),this.Load()},this.Load=function(){store.enabled&&(this.CurTheme=LoadLocalPref("CurTheme","bleu-noir"))},this.Save=function(){store.enabled&&store.set("ColorTheme",this.CurTheme),this.MapPrefs.Save()},this.UpdateVLMPrefs=function(e){switch(e.mapOpponents){case"mylist":case"mapselboats":case"NULL":case"null":case"all":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowSel;break;case"meandtop10":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowTop10;break;case"my10opps":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show10Around;break;case"my5opps":case"maponlyme":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show5Around;break;case"myboat":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowMineOnly;break;default:VLMAlertDanger("unexepected mapping option : "+e.mapOpponents)}}}function MapPrefs(){this.ShowReals=!0,this.ShowOppNumbers=!0,this.MapOppShow=null,this.MapOppShowOptions={ShowSel:0,ShowMineOnly:1,Show5Around:2,ShowTop10:3,Show10Around:4},this.WindArrowsSpacing=64,this.MapZoomLevel=4,this.PolarVacCount=12,this.UseUTC=!1,this.EstTrackMouse=!1,this.TrackEstForecast=!0,this.ShowTopCount=50,this.Load=function(){store.enabled&&(this.ShowReals=LoadLocalPref("#ShowReals",!0),this.ShowOppNumbers=LoadLocalPref("#ShowOppNumbers",!1),this.MapZoomLevel=LoadLocalPref("#MapZoomLevel",4),this.UseUTC=LoadLocalPref("#UseUTC",!1),this.EstTrackMouse=LoadLocalPref("#EstTrackMouse",!0),this.TrackEstForecast=LoadLocalPref("#TrackEstForecast",!1),this.PolarVacCount=LoadLocalPref("#PolarVacCount",12),this.PolarVacCount||(this.PolarVacCount=12),this.ShowTopCount=LoadLocalPref("ShowTopCount",50))},this.Save=function(){store.enabled&&(store.set("#ShowReals",this.ShowReals),store.set("#ShowOppNumbers",this.ShowOppName),store.set("#MapZoomLevel",this.MapZoomLevel),store.set("#PolarVacCount",this.PolarVacCount),store.set("#UseUTC",this.UseUTC),store.set("#TrackEstForecast",this.TrackEstForecast),store.set("#EstTrackMouse",this.EstTrackMouse),store.set("ShowTopCount",this.ShowTopCount));var e="mapselboats";switch(this.MapOppShow){case this.MapOppShowOptions.ShowMineOnly:e="myboat";break;case this.MapOppShowOptions.Show5Around:e="my5opps";break;case this.MapOppShowOptions.ShowTop10:e="meandtop10";break;case this.MapOppShowOptions.Show10Around:e="my10opps"}var t={mapOpponents:e};void 0!==_CurPlayer&&_CurPlayer&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})},this.GetOppModeString=function(e){switch(e){case this.MapOppShowOptions.ShowSel:return GetLocalizedString("mapselboats");case this.MapOppShowOptions.ShowMineOnly:return GetLocalizedString("maponlyme");case this.MapOppShowOptions.Show5Around:return GetLocalizedString("mapmy5opps");case this.MapOppShowOptions.ShowTop10:return GetLocalizedString("mapmeandtop10");case this.MapOppShowOptions.Show10Around:return GetLocalizedString("mapmy10opps");default:return e}}}function AutoPilotOrder(e,t){if(this.Date=new Date((new Date).getTime()-(new Date).getTime()%3e5+45e4),this.PIM=PM_HEADING,this.PIP_Value=0,this.PIP_Coords=new VLMPosition(0,0),this.PIP_WPAngle=-1,this.ID=-1,void 0!==e&&e){if(!(t-1 in e.VLMInfo.PIL))return void alert("Invalid Pilototo order number. Report error to devs.");var a=e.VLMInfo.PIL[t-1];switch(this.Date=new Date(1e3*parseInt(a.TTS,10)),this.PIM=parseInt(a.PIM,10),this.ID=parseInt(a.TID,10),this.PIM){case PM_ANGLE:case PM_HEADING:this.PIP_Value=parseInt(a.PIP,10);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var n=a.PIP.split(","),o=n[1].split("@");this.PIP_Coords.Lat.Value=parseFloat(n[0]),this.PIP_Coords.Lon.Value=parseFloat(o[0]),this.PIP_WPAngle=parseFloat(o[1])}}this.GetOrderDateString=function(){return this.Date.getDate()+"/"+(this.Date.getMonth()+1)+"/"+this.Date.getFullYear()},this.GetOrderTimeString=function(){return this.Date.getHours()+":"+this.Date.getMinutes()+":15"},this.GetPIMString=function(){switch(this.PIM){case PM_HEADING:return GetLocalizedString("autopilotengaged");case PM_ANGLE:return GetLocalizedString("constantengaged");case PM_ORTHO:return GetLocalizedString("orthodromic");case PM_VMG:return"VMG";case PM_VBVMG:return"VBVMG"}},this.GetPIPString=function(){switch(this.PIM){case PM_HEADING:case PM_ANGLE:return this.PIP_Value;case PM_ORTHO:case PM_VMG:case PM_VBVMG:return this.PIP_Coords.GetVLMString()+"@"+PIP_WPAngle}}}function HandleSendAPUpdate(e){var t="add";if(void 0!==_CurAPOrder&&_CurAPOrder){var a={idu:_CurPlayer.CurBoat.IdBoat,tasktime:Math.round(_CurAPOrder.Date/1e3),pim:_CurAPOrder.PIM};switch(-1!==_CurAPOrder.ID&&(t="update",a.taskid=_CurAPOrder.ID),_CurAPOrder.PIM){case PM_HEADING:case PM_ANGLE:a.pip=_CurAPOrder.PIP_Value;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:a.pip={},a.pip.targetlat=_CurAPOrder.PIP_Coords.Lat.Value,a.pip.targetlong=_CurAPOrder.PIP_Coords.Lon.Value,a.pip.targetandhdg=-1===_CurAPOrder.PIP_WPAngle?null:_CurAPOrder.PIP_WPAngle}$.post("/ws/boatsetup/pilototo_"+t+".php","parms="+JSON.stringify(a),function(e){e.success?RefreshCurrentBoat(!1,!0,"AutoPilot"):alert(e.error.msg)})}}function HandleAPFieldChange(e){var t=e.target;if(void 0!==t.attributes.id)switch(t.attributes.id.value){case"AP_PIP":_CurAPOrder.PIP_Value=parseFloat(t.value),_CurAPOrder.PIP_Value.toString()!==t.Value&&(t.value=_CurAPOrder.PIP_Value.toString());break;case"AP_WPLat":CheckFloatInput(_CurAPOrder.PIP_Coords.Lat,t);break;case"AP_WPLon":CheckFloatInput(_CurAPOrder.PIP_Coords.Lon,t);break;case"AP_WPAt":var a={};a.Value=_CurAPOrder.PIP_WPAngle,CheckFloatInput(a,t),_CurAPOrder.PIP_WPAngle=a.Value}}function CheckFloatInput(e,t){var a;"object"===_typeof(e)?(e.Value=parseFloat(t.value),a=e.Value):a=e=parseFloat(t.value),a.toString()!==t.Value&&(t.value=a.toString())}function BoatEstimate(e){this.Position=null,this.Date=null,this.PrevDate=null,this.Mode=null,this.Value=null,this.Meteo=null,this.CurWP=new VLMPosition(0,0),this.HdgAtWP=-1,this.RaceWP=1,this.Heading=null,void 0!==e&&e&&(this.Position=new VLMPosition(e.Position.Lon.Value,e.Position.Lat.Value),this.Date=new Date(e.Date),this.PrevDate=new Date(e.PrevDate),this.Mode=e.Mode,this.Value=e.Value,void 0!==e.Meteo&&e.Meteo&&(this.Meteo=new WindData({Speed:e.Meteo.Speed,Heading:e.Meteo.Heading})),this.CurWP=e.CurWP,this.RaceWP=e.RaceWP,this.Heading=e.Heading)}function Estimator(e){if(void 0===e||!e)throw"Boat must exist for tracking....";this.Boat=e,this.MaxVacEstimate=0,this.CurEstimate=new BoatEstimate,this.Running=!1,this.EstimateTrack=[],this.ProgressCallBack=null,this.ErrorCount=0,this.EstimateMapFeatures=[],this.Stop=function(){this.Running&&(this.Running=!1,this.ReportProgress(!0),DrawBoat(this.Boat))},this.Start=function(e){if(this.ProgressCallBack=e,!this.Running)if(this.Running=!0,GribMgr.Init(),void 0!==this.Boat.VLMInfo){if(this.CurEstimate.Position=new VLMPosition(this.Boat.VLMInfo.LON,this.Boat.VLMInfo.LAT),this.CurEstimate.Date=new Date(1e3*this.Boat.VLMInfo.LUP+1e3*this.Boat.VLMInfo.VAC),this.CurEstimate.PrevDate=this.CurEstimate.Date,this.CurEstimate.Date<new Date)if(void 0===this.Boat.RaceInfo)this.CurEstimate.Date=new Date;else{if(this.CurEstimate.PrevDate=new Date(1e3*parseInt(this.Boat.RaceInfo.deptime,10)+6e3),this.CurEstimate.PrevDate<new Date){var t=(new Date).getTime()/1e3;t-=t%this.Boat.VLMInfo.VAC,this.CurEstimate.PrevDate=new Date(1e3*t+6e3)}var a=new Date(this.CurEstimate.PrevDate.getTime()+1e3*this.Boat.VLMInfo.VAC);this.CurEstimate.Date=a}for(var n in this.CurEstimate.Mode=parseInt(this.Boat.VLMInfo.PIM,10),this.CurEstimate.CurWP=new VLMPosition(this.Boat.VLMInfo.WPLON,this.Boat.VLMInfo.WPLAT),this.CurEstimate.HdgAtWP=parseFloat(this.Boat.VLMInfo["H@WP"]),this.CurEstimate.RaceWP=parseInt(this.Boat.VLMInfo.NWP,10),this.CurEstimate.Mode!=PM_HEADING&&this.CurEstimate.Mode!=PM_ANGLE||(this.CurEstimate.Value=parseFloat(this.Boat.VLMInfo.PIP)),this.CurEstimate.PilOrders=[],this.Boat.VLMInfo.PIL){var o=this.Boat.VLMInfo.PIL[n],i={PIP:o.PIP,PIM:o.PIM,STS:o.STS,TTS:o.TTS};this.CurEstimate.PilOrders.push(i)}this.EstimateTrack=[],this.MaxVacEstimate=new Date(GribMgr.MaxWindStamp),this.ReportProgress(!1),this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.ErrorCount=0,setTimeout(this.Estimate.bind(this),0)}else this.Stop()},this.Estimate=function(e){if(!this.Running||this.CurEstimate.Date>=this.MaxVacEstimate)this.Stop();else{var t,a=this.CurEstimate.Position.Lat.Value,n=this.CurEstimate.Position.Lon.Value;do{if(!(t=GribMgr.WindAtPointInTime(this.CurEstimate.PrevDate,a,n)))return this.ErrorCount>10?void this.Stop():(this.ErrorCount++,void setTimeout(this.Estimate.bind(this),1e3));if(this.ErrorCount=0,isNaN(t.Speed)){alert("Looping on NaN WindSpeed")}}while(isNaN(t.Speed));for(var o in this.CurEstimate.Meteo=t,this.CurEstimate.PilOrders){var i=this.CurEstimate.PilOrders[o];if(i&&"pending"===i.STS)if(new Date(1e3*parseInt(i.TTS,10))<=this.CurEstimate.Date){switch(this.CurEstimate.Mode=parseInt(i.PIM,10),this.CurEstimate.Mode){case PM_ANGLE:case PM_HEADING:this.CurEstimate.Value=parseFloat(i.PIP);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var r=i.PIP.split("@"),s=r[0].split(",");this.CurEstimate.CurWP=new VLMPosition(parseFloat(s[1]),parseFloat(s[0])),this.CurEstimate.HdgAtWP=parseFloat(r[1]);break;default:return alert("unsupported pilototo mode"),void this.Stop()}this.CurEstimate.PilOrders[o]=null;break}}var l=this.CurEstimate.Value,u=0,d=null,c=null;switch(this.CurEstimate.Mode){case PM_ANGLE:l=t.Heading+this.CurEstimate.Value,u=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),d=this.CurEstimate.Position.ReachDistLoxo(u/3600*this.Boat.VLMInfo.VAC,l);break;case PM_HEADING:u=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),d=this.CurEstimate.Position.ReachDistLoxo(u/3600*this.Boat.VLMInfo.VAC,l);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:c=this.GetNextWPCoords(this.CurEstimate),this.CurEstimate.Mode==PM_ORTHO?(l=this.CurEstimate.Position.GetOrthoCourse(c),u=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),d=this.CurEstimate.Position.ReachDistOrtho(u/3600*this.Boat.VLMInfo.VAC,l)):(l=this.CurEstimate.Mode==PM_VMG?PolarsManager.GetVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,c):PolarsManager.GetVBVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,c),u=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),d=this.CurEstimate.Position.ReachDistLoxo(u/3600*this.Boat.VLMInfo.VAC,l)),this.CheckWPReached(c,this.CurEstimate.Position,d);break;default:throw"Unsupported pilotmode for estimate..."+this.CurEstimate.Mode}console.log(this.CurEstimate.Date+this.CurEstimate.Position.toString(!0)+"=> "+d.Lon.toString(!0)+" "+d.Lat.toString(!0)+" Wind : "+RoundPow(t.Speed,4)+"@"+RoundPow(t.Heading,4)+" Boat "+RoundPow(u,4)+"kts"+RoundPow((l+360)%360,4));var p=!1;this.CheckGateValidation(d)&&(p=this.GetNextRaceWP()),this.CurEstimate.Heading=l,this.CurEstimate.Position=d,this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.CurEstimate.Date=new Date(1e3*(this.CurEstimate.Date/1e3+this.Boat.VLMInfo.VAC)),this.CurEstimate.PrevDate=this.CurEstimate.Date,p?this.Stop():(setTimeout(this.Estimate.bind(this),0),this.ReportProgress(!1))}},this.GetNextRaceWP=function(){var e=Object.keys(this.Boat.RaceInfo.races_waypoints).length;if(this.CurEstimate.RaceWP===e)return!0;for(var t=this.CurEstimate.RaceWP+1;t<=e;t++)if(!(this.Boat.RaceInfo.races_waypoints[t].wpformat&WP_ICE_GATE)){this.CurEstimate.RaceWP=t;break}return!1},this.CheckGateValidation=function(e){var t=this.GetNextGateSegment(this.CurEstimate),a=(this.Boat.RaceInfo.races_waypoints[this.CurEstimate.RaceWP],{P1:this.CurEstimate.Position,P2:e});return VLMMercatorTransform.SegmentsIntersect(t,a)},this.CheckWPReached=function(e,t,a){if(this.CurEstimate.CurWP.Lat.value||this.CurEstimate.CurWP.Lon.Value){var n=e.GetOrthoDist(t),o=e.GetOrthoDist(a),i=t.GetOrthoDist(a);(n<i||o<i)&&(this.CurEstimate.CurWP=new VLMPosition(0,0),-1!=this.CurEstimate.HdgAtWP&&(this.CurEstimate.Mode=PM_HEADING,this.CurEstimate.Value=this.CurEstimate.HdgAtWP),console.log("WP Reached"))}},this.GetNextWPCoords=function(e){return e.CurWP.Lat.value||e.CurWP.Lon.Value?e.CurWP:this.Boat.GetNextWPPosition(e.RaceWP,e.Position,e.CurWP)},this.GetNextGateSegment=function(e){return this.Boat.GetNextGateSegment(e.RaceWP)},this.ReportProgress=function(e){var t=0;this.ProgressCallBack&&(e||this.EstimateTrack.length>1&&(t=RoundPow(100*(1-(t=(this.MaxVacEstimate-this.EstimateTrack[this.EstimateTrack.length-1].Date)/(this.MaxVacEstimate-this.EstimateTrack[0].Date))),1)),this.ProgressCallBack(e,t,this.CurEstimate.Date))},this.GetClosestEstimatePoint=function(e){return e instanceof VLMPosition?this.GetClosestEstimatePointFromPosition(e):e instanceof Date?this.GetClosestEstimatePointFromTime(e):null},this.GetClosestEstimatePointFromTime=function(e){if(!e||!Object.keys(this.EstimateTrack).length)return null;var t,a=0;for(a=0;a<Object.keys(this.EstimateTrack).length;a++)if(this.EstimateTrack[a]){if(!(e>this.EstimateTrack[a].Date))break;t=e-this.EstimateTrack[a].Date}if(a<Object.keys(this.EstimateTrack).length&&void 0!==this.EstimateTrack[a+1]&&this.EstimateTrack[a+1]){var n=e-this.EstimateTrack[a+1].Date;Math.abs(n)<Math.abs(t)&&a++}return this.EstimateTrack[a]},this.GetClosestEstimatePointFromPosition=function(e){if(!e)return null;var t,a=1e30,n=null;for(t=0;t<Object.keys(this.EstimateTrack).length;t++)if(this.EstimateTrack[t]){var o=e.GetEuclidianDist2(this.EstimateTrack[t].Position);o<a&&(n=this.EstimateTrack[t],a=o)}return n},this.ClearEstimatePosition=function(e){this.ShowEstimatePosition(e,null)},this.ShowEstimatePosition=function(e,t){t&&t.Position&&(e.VLMInfo.LON!==t.Position.Lon.Value||(e.VLMInfo.LAT,t.Position.Lat.Value))},this.GetEstimateTracks=function(){var e=[],t=null,a=null;if(this.EstimateTrack&&this.EstimateTrack[0]){var n=(new Date).getTime(),o=n-n%216e5+126e5;for(var i in this.EstimateTrack)if(this.EstimateTrack[i]){var r=this.EstimateTrack[i],s=r.Date.getTime()-o,l=Math.floor(s/6/36e5);l<0?l=0:l>2&&(l=2),void 0===e[l]&&(e[l]=[]),l!==t&&a&&e[l].push([a.Position.Lat.Value,a.Position.Lon.Value]),e[l].push([r.Position.Lat.Value,r.Position.Lon.Value]),a=r,t=l}}return e}}function Coords(e,t){this.Value="number"==typeof e?e:parseFloat(e),this.IsLon=t,this.Deg=function(){return Math.abs(this.Value)},this.Min=function(){return 60*(Math.abs(this.Value)-Math.floor(this.Deg()))},this.Sec=function(){return 60*(this.Min()-Math.floor(this.Min()))},this.toString=function(e){if(e)return this.Value;var t="";return t=void 0===this.IsLon||0==this.IsLon?this.Value>=0?" N":" S":this.Value>=0?" E":" W",Math.floor(this.Deg())+"° "+Math.floor(this.Min())+"' "+RoundPow(this.Sec(),2)+'"'+t}}function GetDegMinSecFromNumber(e,t,a,n){SplitNumber(e,t,void 0),SplitNumber(NaN,a,void 0),SplitNumber(NaN,n,void 0)}function SplitNumber(e,t,a){Math.floor(e)}VLM2Prefs.Init();var SrvIndex=1,Gribmap={ServerURL:function(){return"undefined"!=typeof WindGridServers&&WindGridServers?(0===(SrvIndex=(SrvIndex+1)%WindGridServers.length)&&(SrvIndex=1),WindGridServers[SrvIndex]):""}},GribMgr=new VLM2GribManager;function GribData(e){this.UGRD=NaN,this.VGRD=NaN,this.TWS=NaN,void 0!==e&&(this.UGRD=e.UGRD,this.VGRD=e.VGRD,this.TWS=e.TWS),this.Strength=function(){return 1.9438445*Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD)},this.Direction=function(){var e=Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD),t=Math.acos(-this.VGRD/e);return this.UGRD>0&&(t=2*Math.PI-t),(t=t/Math.PI*180%360)<0?t+=360:t>=360&&(t-=360),t}}function WindData(e){this.Speed=NaN,this.Heading=NaN,this.IsValid=function(){return!isNaN(this.Speed)&&!isNaN(this.Heading)},void 0!==e&&(this.Speed=e.Speed,this.Heading=e.Heading)}function VLM2GribManager(){this.Tables=[],this.TableTimeStamps=[],this.Inited=!1,this.Initing=!1,this.MinWindStamp=0,this.MaxWindStamp=0,this.WindTableLength=0,this.LoadQueue=[],this.GribStep=.5,this.LastGribDate=new Date(0),this.Init=function(){this.Inited||this.Initing||(this.Initing=!0,$.get("/ws/windinfo/list.php?v="+Math.round((new Date).getTime()/1e3/60/3),this.HandleGribList.bind(this)))},this.HandleGribList=function(e){this.TableTimeStamps=e.grib_timestamps,this.Inited=!0,this.Initing=!1,this.MinWindStamp=new Date(1e3*this.TableTimeStamps[0]),this.MaxWindStamp=new Date(1e3*this.TableTimeStamps[this.TableTimeStamps.length-1]),this.WindTableLength=this.TableTimeStamps.length},this.WindAtPointInTime=function(e,t,a,n){if(!this.Inited)return!1;var o=Math.floor((e/1e3-this.MinWindStamp/1e3)/10800);if(o<0)return!1;if(o+1>=this.TableTimeStamps.length)return!1;var i=new WindData;if(Math.abs(t)>85)return i.Heading=0,i.Speed=0,i;var r=this.CheckGribLoaded(o,t,NormalizeLongitudeDeg(a)),s=this.CheckGribLoaded(o+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep),n);if(r&&!s&&(s=this.CheckGribLoaded(o+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep))),!r||!s)return!1;var l=this.GetHydbridMeteoAtTimeIndex(o,t,a),u=this.GetHydbridMeteoAtTimeIndex(o+1,t,a),d=l.UGRD,c=l.VGRD,p=u.UGRD,h=u.VGRD,P=e/1e3-this.TableTimeStamps[o],f=new GribData({UGRD:d+P/10800*(p-d),VGRD:c+P/10800*(h-c)});return i.Heading=f.Direction(),i.Speed=l.TWS+P/10800*(u.TWS-l.TWS),i},this.GetHydbridMeteoAtTimeIndex=function(e,t,a){for(var n=180/this.GribStep+Math.floor(a/this.GribStep),o=90/this.GribStep+Math.floor(t/this.GribStep),i=(n+1)%(360/this.GribStep),r=(o+1)%(180/this.GribStep),s=a;s<0;)s+=180;for(var l=t;l<0;)l+=90;var u=s/this.GribStep-Math.floor(s/this.GribStep),d=l/this.GribStep-Math.floor(l/this.GribStep),c=this.Tables[e][n][o].UGRD,p=this.Tables[e][n][r].UGRD,h=this.Tables[e][i][o].UGRD,P=this.Tables[e][i][r].UGRD,f=this.Tables[e][n][o].VGRD,g=this.Tables[e][n][r].VGRD,L=this.Tables[e][i][o].VGRD,M=this.Tables[e][i][r].VGRD,m=this.Tables[e][n][o].Strength(),I=this.Tables[e][n][r].Strength(),C=this.Tables[e][i][o].Strength(),v=this.Tables[e][i][r].Strength(),R=this.QuadraticAverage(m,I,C,v,u,d);return new GribData({UGRD:this.QuadraticAverage(c,p,h,P,u,d),VGRD:this.QuadraticAverage(f,g,L,M,u,d),TWS:R})},this.QuadraticAverage=function(e,t,a,n,o,i){var r=e+i*(t-e);return r+o*(a+i*(n-a)-r)},this.CheckGribLoaded=function(e,t,a,n){var o=180/this.GribStep+Math.floor(a/this.GribStep),i=90/this.GribStep+Math.floor(t/this.GribStep),r=180/this.GribStep+Math.ceil(a/this.GribStep),s=90/this.GribStep+Math.ceil(t/this.GribStep);return!!(e in this.Tables&&this.Tables[e][o]&&this.Tables[e][o][i]&&this.Tables[e][o][s]&&this.Tables[e][r]&&this.Tables[e][r][i]&&this.Tables[e][r][s])||(this.CheckGribLoadedIdx(e,o,i,n),this.CheckGribLoadedIdx(e,o,s,n),this.CheckGribLoadedIdx(e,r,i,n),this.CheckGribLoadedIdx(e,r,s,n),!1)},this.CheckGribLoadedIdx=function(e,t,a,n){if(isNaN(t)||isNaN(a));if(!(this.Tables.length&&this.Tables[e]&&this.Tables[e][t]&&this.Tables[e][t][a])){var o,i,r=a*this.GribStep-90,s=t*this.GribStep-180,l=5*Math.floor(r/5),u=5*Math.floor(s/5);r<l?l=(o=l)-10:o=l+10,s<u?u=(i=u)-10:i=u+10,i>180&&(i=180,this.CheckGribLoadedIdx(e,0,a,n)),u<-180&&(u=-180,this.CheckGribLoadedIdx(e,180/this.GribStep-1,a,n));var d="0/"+u+"/"+i+"/"+o+"/"+l;this.AddGribLoadKey(d,o,l,u,i)}},this.AddGribLoadKey=function(e,t,a,n,o){e in this.LoadQueue||(this.LoadQueue[e]={length:0,CallBacks:[]},this.LoadQueue[e].Length=0,$.get(Gribmap.ServerURL()+"/ws/windinfo/smartgribs.php?north="+t+"&south="+a+"&west="+n+"&east="+o+"&seed="+(0+new Date),this.HandleGetSmartGribList.bind(this,e))),"undefined"!=typeof callback&&callback&&this.LoadQueue[e].CallBacks.push(callback)},this.HandleGetSmartGribList=function(e,t){if(t.success){for(var a in this.LastGribDate!==parseInt(t.GribCacheIndex,10)&&(this.LastGribDate=parseInt(t.GribCacheIndex,10),this.Tables=[],this.Inited=!1,this.Init()),t.gribs_url)if(t.gribs_url[a]){var n=t.gribs_url[a].replace(".grb",".txt");$.get("/cache/gribtiles/"+n+"&v=0",this.HandleSmartGribData.bind(this,e,n)),this.LoadQueue[e].Length++}}else console.log(t)},this.HandleSmartGribData=function(e,t,a){if(this.ProcessInputGribData(t,a,e),this.LoadQueue[e].Length--,!this.LoadQueue[e].Length){for(var n in this.LoadQueue[e].CallBacks)this.LoadQueue[e].CallBacks[n]&&this.LoadQueue[e].CallBacks[n]();delete this.LoadQueue[e]}},this.ForceReloadGribCache=function(e,t){$.get("/cache/gribtiles/"+t+"&force=yes&seed=0",this.HandleSmartGribData.bind(this,e,t)),this.LoadQueue[e].Length++},this.ProcessInputGribData=function(e,t,a){var n=t.split("\n"),o=n.length,i=[],r=0;if("--\n"!==t)if(-1===t.search("invalid")){for(var s=0;s<o;s++){var l=n[s];if("--"===l){r=s+1;break}l&&-1===l.search("GRID:")&&i.push(this.ProcessCatalogLine(l))}if(i.length<this.WindTableLength)this.ForceReloadGribCache(a,e);else for(var u=e.split("/"),d=0;d<i.length;d++){if(void 0===n[r]||""===n[r]){this.ForceReloadGribCache(a,e);break}for(var c=n[r].split(" "),p=parseInt(c[0],10),h=parseInt(c[1],10),P=180/this.GribStep+parseInt(u[1],10)/this.GribStep,f=0;f<p;f++)for(var g=h+90/this.GribStep+parseInt(u[0],10)/this.GribStep,L=0;L<h;L++){i[d].DateIndex in this.Tables||(this.Tables[i[d].DateIndex]=[]);var M=this.Tables[i[d].DateIndex];P+f in M||(M[P+f]=[]),g-L-1 in M[P+f]||(M[P+f][g-L-1]=null);var m=this.Tables[i[d].DateIndex][P+f][g-L-1];void 0!==m&&m||(m=new GribData,this.Tables[i[d].DateIndex][P+f][g-L-1]=m),m[i[d].Type]=parseFloat(n[r+1+L*p+f])}r+=p*h+1}}else console.log("invalid request :"+e);else this.ForceReloadGribCache(a,e)},this.ProcessCatalogLine=function(e){var t=new WindCatalogLine,a=e.split(":");return t.Type=a[3],void 0===a[12]||"anl"===a[12]?t.DateIndex=0:t.DateIndex=parseInt(a[12].substring(0,a[12].indexOf("hr")),10)/3,t}}function WindCatalogLine(){this.Type="",this.DateIndex=0}function WindTable(){this.GribStep=.5,this.Table=[],this.TableDate=0,this.Init=function(e){for(lat=-90;lat<=90;lat+=this.GribStep)for(lon=-90;lon<=90;lon+=this.GribStep)this.Table[lat][lon]=null}}function HandleGribTestClick(e){for(var t=_CurPlayer.CurBoat,a=0;a<=0;a++){var n=new Date(1e3*t.VLMInfo.LUP+a*t.VLMInfo.VAC*1e3),o=GribMgr.WindAtPointInTime(n,t.VLMInfo.LAT,t.VLMInfo.LON);o?console.log(n+" "+o.Speed+"@"+o.Heading):console.log("no meteo yet at time : "+n)}}GribMgr.Init();var RACE_TYPE_CLASSIC=0,RACE_TYPE_RECORD=1,RACE_TYPE_OMORMB=2,FIELD_MAPPING_TEXT=0,FIELD_MAPPING_VALUE=1,FIELD_MAPPING_CHECK=2,FIELD_MAPPING_IMG=3,FIELD_MAPPING_CALLBACK=4,MAX_PILOT_ORDERS=5,BoatRacingStatus=["RAC","CST","LOC","DNS"],BoatArrivedStatus=["ARR"],BoatNotRacingStatus=["DNF","HC","HTP"],BoatRacingClasses={RAC:"ft_class_racing",CST:"ft_class_oncoast",LOC:"ft_class_locked",DNS:"ft_class_dns"},SetWPPending=!1,WPPendingTarget=null,GribWindController=null,map=null,VLMBoatsLayer=null,Rankings=[],PilototoFt=null,RankingFt=null,RaceHistFt=null,ICS_WPft=null,NSZ_WPft=null,VLMINdexFt=null,RC_PwdResetReq=null,RC_PwdResetConfirm=null,OnPlayerLoadedCallBack=null;function LeafletInit(){map=L.map("jVlmMap").setView([0,0],8);var e=tileUrlSrv;L.tileLayer(e,{attribution:"gshhsv2",maxZoom:20,tms:!1,id:"vlm",detectRetina:!0,subdomains:tilesUrlArray}).addTo(map),map.on("mousemove",HandleMapMouseMove)}$(document).ready(function(){$.ajaxSetup({error:function(e,t,a){401===e.status||403===e.status?window.location.replace("/"):404===e.status||VLMAlertDanger("An error occurred: "+t+"nError: "+a)}}),LeafletInit(),InitLocale(),InitMenusAndButtons(),PolarsManager.Init(),InitAlerts(),CheckPageParameters(),setInterval(PageClock,1e3),GetFlagsList()});var PasswordResetInfo=[];function HandlePasswordResetLink(e){PasswordResetInfo=unescape(e).split("|"),initrecaptcha(!1,!0),$("#ResetaPasswordConfirmation").modal("show")}function CheckPageParameters(){var e=window.location.search,t=!0;if(e){var a=e.split("?")[1].split("&");for(var n in a)a[n]&&function(){var e=a[n].split("=");switch(e[0]){case"PwdResetKey":HandlePasswordResetLink(e[1]);break;case"RaceRank":t=!1,RankingFt.OnReadyTable=function(){HandleShowOtherRaceRank(e[1])};break;case"VLMIndex":t=!1,VLMINdexFt.OnReadyTable=function(){HandleShowIndex(e[1])};break;case"ICSRace":t=!1,HandleShowICS(e[1])}}()}t?($(".RaceNavBar").css("display","inherit"),$(".OffRaceNavBar").css("display","none")):($(".RaceNavBar").css("display","none"),$(".OffRaceNavBar").css("display","inherit"),ShowApropos(!1))}function HandleShowICS(e){LoadRaceInfo(e,null,function(e){e&&(FillRaceInstructions(e),$("#RacesInfoForm").modal("show"))})}function LoadRaceInfo(e,t,a){t||(t=""),$.get("/ws/raceinfo/desc.php?idrace="+e+"&v="+t,a)}function HandleVLMIndex(e){if(e){var t;$("#Ranking-Panel").show();var a=1;for(t in e)e[t]&&(e[t].rank=a,a++);BackupVLMIndexTable(),VLMINdexFt.loadRows(e),$("#DivVlmIndex").removeClass("hidden"),$("#RnkTabsUL").addClass("hidden"),$("#DivRnkRAC").addClass("hidden"),ShowApropos(!0)}}function HandleShowIndex(e){var t=HandleVLMIndex;$.get("/cache/rankings/VLMIndex_"+e+".json",t)}function HandleShowOtherRaceRank(e){OnPlayerLoadedCallBack=function(){LoadRaceInfo(e,0,function(e){FillRaceInfoHeader(e)}),LoadRankings(e,OtherRaceRankingLoaded),RankingFt.RaceRankingId=e},void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&(OnPlayerLoadedCallBack(),OnPlayerLoadedCallBack=null)}function OtherRaceRankingLoaded(){$("#Ranking-Panel").show(),SortRanking("RAC"),console.log("off race ranking loaded")}function initrecaptcha(e,t){e&&!RC_PwdResetReq&&(RC_PwdResetReq=grecaptcha.render("recaptcha-PwdReset1")),t&&!RC_PwdResetConfirm&&(RC_PwdResetConfirm=grecaptcha.render("recaptcha-PwdReset2"))}function InitMenusAndButtons(){$("div.vresp.modal").on("show.bs.modal",function(){$(this).show(),setModalMaxHeight(this)}),$(window).resize(function(){0!=$(".modal.in").length&&setModalMaxHeight($(".modal.in"))}),$("#BtnChangePassword").on("click",function(e){e.preventDefault(),HandlePasswordChangeRequest(e)}),$("#ResetPasswordButton").on("click",function(e){null!==RC_PwdResetReq&&grecaptcha.execute(RC_PwdResetReq)}),$("#ConfirmResetPasswordButton").on("click",function(e){null!==RC_PwdResetConfirm&&grecaptcha.execute(RC_PwdResetConfirm)}),$("#LoginForm").on("show.bs.modal",function(e){ShowApropos(!1)}),$("#LoginForm").on("hide.bs.modal",function(e){ShowApropos(!0)}),$(".logindlgButton").on("click",function(e){$("#LoginForm").modal("show")}),$(".logOutButton").on("click",function(e){Logout()}),$("#Menu").menu(),$("#Menu").hide(),$("input[type=submit],button").button().click(function(e){e.preventDefault()}),$(".JVLMTabs").tabs(),HidePb("#PbLoginProgress"),HidePb("#PbGetBoatProgress"),HidePb("#PbGribLoginProgress"),$(".BCPane.WP_PM_Mode").click(function(){MoveWPBoatControlerDiv("#"+$(this)[0].classList[2])}),$(".BtnRaceList").click(function(){LoadRacesList(),$("#RacesListForm").modal("show")}),InitRankingEvents(),$("#LoginButton").click(function(){OnLoginRequest()}),$("#LoginPanel").keypress(function(e){"13"===e.which&&(OnLoginRequest(),$("#LoginForm").modal("hide"))}),$("#BtnSetting").click(function(){LoadVLMPrefs(),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}),$("#SettingValidateButton").click(SaveBoatAndUserPrefs),$("#SettingCancelButton").click(function(){LoadVLMPrefs(),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}),$("#SettingValidateButton").click(SaveBoatAndUserPrefs),$("#SettingCancelButton").click(function(){SetDDTheme(VLM2Prefs.CurTheme)}),$("#BtnPM_Heading").click(function(){SendVLMBoatOrder(PM_HEADING,$("#PM_Heading")[0].value)}),$("#BtnPM_Angle").click(function(){SendVLMBoatOrder(PM_ANGLE,$("#PM_Angle")[0].value)}),$("#BtnPM_Tack").click(function(){$("#PM_Angle")[0].value=-$("#PM_Angle")[0].value}),$("#BtnCreateAccount").click(function(){HandleCreateUser()}),$(".CreatePassword").pstrength(),$("#NewPlayerEMail").blur(function(e){$("#NewPlayerEMail").verimail({messageElement:"#verimailstatus",language:_CurLocale})}),$("#InscriptForm").on("shown.bs.modal",function(){$(this).find("div.modal-body :input").val("")}),$("#SetWPOnClick").click(HandleStartSetWPOnClick),$("#SetWPOffClick").click(HandleCancelSetWPOnClick),HandleCancelSetWPOnClick(),$("body").on("click",".PIL_EDIT",HandlePilotEditDelete),$("body").on("click",".PIL_DELETE",HandlePilotEditDelete),$("#AutoPilotAddButton").click(HandleOpenAutoPilotSetPoint),$("#AP_SetTargetWP").click(HandleClickToSetWP),$("#AP_Time").datetimepicker({locale:_CurLocale,format:"DD MM YYYY, HH:mm:ss"}),$("#AP_Time").on("dp.change",HandleDateChange),$("#APValidateButton").click(HandleSendAPUpdate),$(".APField").on("change",HandleAPFieldChange),$(".APMode").on("click",HandleAPModeDDClick),$(".Draggable").draggable({handle:".modal-header,.modal-body"}),$("#MapPrefsToggle").click(HandleShowMapPrefs),$(".chkprefstore").on("change",HandleMapPrefOptionChange),$(".MapOppShowLi").click(HandleMapOppModeChange),$(".DDTheme").click(HandleDDlineClick),$("#StartEstimator").on("click",HandleStartEstimator),$("#EstimatorStopButton").on("click",HandleStopEstimator),InitGribSlider(),InitFootables(),$(document.body).on("click",".RaceHistLink",function(e){HandleShowBoatRaceHistory(e)}),$("[PilRefresh]").on("click",HandleUpdatePilototoTable),$("#HistRankingButton").on("click",function(e){ShowUserRaceHistory(_CurPlayer.CurBoat.IdBoat)}),$("#BtnPM_Ortho, #BtnPM_VMG, #BtnPM_VBVMG").click(function(){var e,t=PM_ORTHO,a=$("#PM_Lat")[0].value,n=$("#PM_Lon")[0].value;switch(e=parseInt($("#PM_WPHeading")[0].value,10),$(this)[0].id){case"BtnPM_Ortho":t=PM_ORTHO;break;case"BtnPM_VMG":t=PM_VMG;break;case"BtnPM_VBVMG":t=PM_VBVMG}SendVLMBoatOrder(t,n,a,e)}),$("#CalendarPanel").on("shown.bs.modal",function(e){HandleShowAgenda()}),$(".BoatSelectorDropDownList").on("click",HandleBoatSelectionChange),$("#cp11").colorpicker({useAlpha:!1,format:!1}),$(document.body).on("click",".ShowICSButton",function(e){HandleFillICSButton(e)}),$(document.body).on("click",".ShowRaceInSpectatorMode",function(e){HandleGoToRaceSpectator(e)}),$("#PolarTab").on("click",HandlePolarTabClik),CheckLogin(),UpdateVersionLine()}function InitRankingEvents(){$("#Ranking-Panel").on("shown.bs.collapse",function(e){HandleRaceSortChange(e)}),$(document.body).on("click",".RankingButton",function(e){var t=$(e.currentTarget).attr("IdRace");void 0!==t&&t&&window.open("/jvlm?RaceRank="+t,"RankTab")}),$(document.body).on("click","[RnkSort]",function(e){HandleRaceSortChange(e)}),$("#Ranking-Panel").on("hide.bs.collapse",function(e){ResetRankingWPList(e)})}function UpdateVersionLine(){var e=new moment(BuildDate);$("#BuildDate").text("Build : "+e.fromNow()),$('[data-toggle="tooltip"]').tooltip()}var _CachedRaceInfo=null;function HandlePolarTabClik(){_CachedRaceInfo&&DrawPolar(_CachedRaceInfo)}function InitPolar(e){_CachedRaceInfo=e}function HandleGoToRaceSpectator(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void window.open("/guest_map/index.html?idr="+t,"Spec_"+t)}}function HandleFillICSButton(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void HandleShowICS(t)}void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&FillRaceInstructions(_CurPlayer.CurBoat.RaceInfo)}var CalInited=!1;function HandleShowAgenda(){jQuery("#Calendar").fullCalendar("destroy"),jQuery("#Calendar").fullCalendar({locale:_CurLocale,editable:!1,header:{left:"title",center:"",right:"today prev,next"},firstDay:1,events:"/feed/races.fullcalendar.php",data:function(){return{jvlm:1}},timeFormat:"H:mm",loading:function(e){e?jQuery("#loading").show():jQuery("#loading").hide()}}),CalInited=!0,$("#Infos").modal("hide")}function HandlePasswordChangeRequest(e){var t=$("#CurPassword")[0].value,a=$("#NewPassword1")[0].value,n=$("#NewPassword2")[0].value;if($(".Password").val(""),t&&""!==t)if(a===n)if(""!==a){var o={OldPwd:t,NewPwd:a};$.post("/ws/playersetup/password_change.php","parms="+JSON.stringify(o),function(e){HandlePasswordChangeResult(e)})}else VLMAlertDanger(GetLocalizedString("NewPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"))}function HandlePasswordChangeResult(e){e.success?VLMAlertInfo():VLMAlertDanger(GetLocalizedString(e.error.msg))}function SendResetPassword(e){PasswordResetInfo[0],PasswordResetInfo[1];$.get("/ws/playersetup/password_reset.php?email="+PasswordResetInfo[0]+"&seed="+PasswordResetInfo[1]+"&key="+e,function(e){HandlePasswordReset(e,!0)})}function SendResetPasswordLink(e){var t=$(".UserName").val();if(""===t)return VLMAlertDanger(GetLocalizedString("Enter your email for resetting your password")),void grecaptcha.reset(RC_PwdResetReq);var a={email:t,key:e};$.post("/ws/playersetup/password_reset.php","parms="+JSON.stringify(a),function(e){HandlePasswordReset(e,!1)})}function HandlePasswordReset(e,t){e.success?t?(VLMAlertInfo(GetLocalizedString("Check your inbox to get your new password.")),grecaptcha.reset(RC_PwdResetReq)):(VLMAlertInfo(GetLocalizedString("An email has been sent. Click on the link to validate.")),grecaptcha.reset(RC_PwdResetConfirm)):(VLMAlertDanger("Something went wrong :("),grecaptcha.reset(RC_PwdResetReq),grecaptcha.reset(RC_PwdResetConfirm))}function InitFooTable(e){var t=FooTable.init("#"+e,{name:e,on:{"ready.ft.table":HandleReadyTable,"after.ft.paging":HandlePagingComplete,"postdraw.ft.table":HandleTableDrawComplete}});return t.DrawPending=!0,t.CallbackPending=null,t}function InitFootables(){$("#DiscontinueRaceButton").on("click",HandleDiscontinueRaceRequest),PilototoFt=InitFooTable("PilototoTable"),RankingFt=InitFooTable("RankingTable"),RaceHistFt=InitFooTable("BoatRaceHist"),ICS_WPft=InitFooTable("RaceWayPoints"),NSZ_WPft=InitFooTable("NSZPoints"),VLMINdexFt=InitFooTable("VLMIndexTable")}function HandleUpdatePilototoTable(e){UpdatePilotInfo(_CurPlayer.CurBoat)}function InitSlider(e,t,a,n,o,i){var r=$("#"+t);$("#"+e).slider({orientation:"vertical",min:a,max:n,value:o,create:function(){r.text($(this).slider("value"))},slide:function(e,t){i(e,t)}})}function InitGribSlider(){InitSlider("GribSlider","GribSliderHandle",0,72,0,HandleGribSlideMove)}function HandleRaceSortChange(e){var t=$(e.currentTarget).attr("rnksort");switch(t){case"WP":SortRanking(t,$(e.currentTarget).attr("WPRnk"));break;case"DNF":case"HTP":case"HC":case"ABD":case"RAC":case"ARR":SortRanking(t);break;default:console.log("Sort change request"+e)}}function HandleGribSlideMove(e,t){$("#GribSliderHandle").text(t.value);var a=GribWindController.getGribmapLayer(),n=(new Date).getTime();(a.setTimeSegment(n/1e3+3600*t.value),VLM2Prefs.MapPrefs.TrackEstForecast&&_CurPlayer.CurBoat.Estimator)&&(RefreshEstPosLabels(_CurPlayer.CurBoat.GetClosestEstimatePoint(new Date(n+3600*t.value*1e3))),StartEstimateTimeout())}function HandleDiscontinueRaceRequest(){GetUserConfirmation(GetLocalizedString("unsubscribe"),!0,HandleRaceDisContinueConfirmation)}function HandleRaceDisContinueConfirmation(e){e?(DiconstinueRace(_CurPlayer.CurBoat.IdBoat,_CurPlayer.CurBoat.Engaged),$("#ConfirmDialog").modal("hide"),$("#RacesInfoForm").modal("hide")):VLMAlertDanger("Ouf!")}function HandleStopEstimator(e){var t=_CurPlayer.CurBoat;void 0!==t&&t&&t.Estimator.Stop()}function HandleStartEstimator(e){var t=_CurPlayer.CurBoat;void 0!==t&&t&&t.Estimator.Start(HandleEstimatorProgress)}var LastPct=-1;function HandleEstimatorProgress(e,t,a){e?($("#StartEstimator").removeClass("hidden"),$("#PbEstimatorProgressBar").addClass("hidden"),$("#EstimatorStopButton").addClass("hidden"),LastPct=-1):t-LastPct>.15&&($("#EstimatorStopButton").removeClass("hidden"),$("#StartEstimator").addClass("hidden"),$("#PbEstimatorProgressBar").removeClass("hidden"),$("#PbEstimatorProgressText").removeClass("hidden"),$("#PbEstimatorProgressText").text(t),$("#PbEstimatorProgress").css("width",t+"%"),$("#PbEstimatorProgress").attr("aria-valuenow",t),$("#PbEstimatorProgress").attr("aria-valuetext",t),LastPct=t)}function HandleFlagLineClick(e){SelectCountryDDFlag(e.target.attributes.flag.value)}function HandleCancelSetWPOnClick(){SetWPPending=!1,$("#SetWPOnClick").show(),$("#SetWPOffClick").hide()}function HandleStartSetWPOnClick(){SetWPPending=!0,WPPendingTarget="WP",$("#SetWPOnClick").hide(),$("#SetWPOffClick").show()}function ClearBoatSelector(){$(".BoatSelectorDropDownList").empty()}function AddBoatToSelector(e,t){BuildUserBoatList(e,t)}function BuildUserBoatList(e,t){$(".BoatSelectorDropDownList").append(GetBoatDDLine(e,t))}function GetBoatDDLine(e,t){var a='<li class="DDLine" BoatID="'+e.IdBoat+'">';return a=a+GetBoatInfoLine(e,t)+"</li>"}function GetBoatInfoLine(e,t){var a="",n="racing";return e.Engaged||(n="Docked"),void 0!==e.VLMInfo&&e.VLMInfo["S&G"]&&(n="stranded"),t||(a+='<span class="badge">BS'),a=a+'<img class="BoatStatusIcon" src="images/'+n+'.png" />',t||(a+="</span>"),a=a+"<span>-</span><span>"+HTMLDecode(e.BoatName)+"</span>"}function ShowBgLoad(){$("#BgLoadProgress").css("display","block")}function HideBgLoad(){$("#BgLoadProgress").css("display","block")}function ShowPb(e){$(e).show()}function HidePb(e){$(e).hide()}function DisplayLoggedInMenus(e){var t,a;e?(t="block",a="none"):(t="none",a="block"),$("[LoggedInNav='true']").css("display",t),$("[LoggedInNav='false']").css("display",a),void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.IsAdmin?$("[AdminNav='true']").css("display","block"):$("[AdminNav='true']").css("display","none"),ShowApropos(e)}function ShowApropos(e){$("#Apropos").modal(e?"hide":"show")}function HandleRacingDockingButtons(e){e?($('[RacingBtn="true"]').removeClass("hidden"),$('[RacingBtn="false"]').addClass("hidden")):($('[RacingBtn="true"]').addClass("hidden"),$('[RacingBtn="false"]').removeClass("hidden"))}function UpdateInMenuDockingBoatInfo(e){HandleRacingDockingButtons(void 0!==e&&void 0!==e.VLMInfo&&parseInt(e.VLMInfo.RAC,10))}function SetTWASign(e){var t=e.VLMInfo.TWD,a=e.VLMInfo.HDG,n=t-a;n<-180&&(n+=360),n>180&&(n-=360);n*e.VLMInfo.TWA>0&&(e.VLMInfo.TWA=-e.VLMInfo.TWA)}function UpdateInMenuRacingBoatInfo(e,t){if(e&&void 0!==e){HandleRacingDockingButtons(!0),SetTWASign(e),"2"===e.VLMInfo.PIM&&"0"===e.VLMInfo.PIP&&(e.VLMInfo.HDG=e.VLMInfo.TWD,e.VLMInfo.BSP=0);var a=new Coords(e.VLMInfo.LON,!0),n=new Coords(e.VLMInfo.LAT),o=[];o.push([FIELD_MAPPING_TEXT,"#BoatLon",a.toString()]),o.push([FIELD_MAPPING_TEXT,"#BoatLat",n.toString()]),o.push([FIELD_MAPPING_TEXT,".BoatSpeed",RoundPow(e.VLMInfo.BSP,2)]),o.push([FIELD_MAPPING_TEXT,".BoatHeading",RoundPow(e.VLMInfo.HDG,1)]),o.push([FIELD_MAPPING_VALUE,"#PM_Heading",RoundPow(e.VLMInfo.HDG,2)]),o.push([FIELD_MAPPING_TEXT,"#BoatAvg",RoundPow(e.VLMInfo.AVG,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatDNM",RoundPow(e.VLMInfo.DNM,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatLoch",RoundPow(e.VLMInfo.LOC,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatOrtho",RoundPow(e.VLMInfo.ORT,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatLoxo",RoundPow(e.VLMInfo.LOX,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatVMG",RoundPow(e.VLMInfo.VMG,1)]),o.push([FIELD_MAPPING_TEXT,".BoatWindSpeed",RoundPow(e.VLMInfo.TWS,1)]),o.push([FIELD_MAPPING_TEXT,"#BoatWindDirection",RoundPow(e.VLMInfo.TWD,1)]),o.push([FIELD_MAPPING_CHECK,"#PM_WithWPHeading","-1.0"!==e.VLMInfo["H@WP"]]),o.push([FIELD_MAPPING_TEXT,"#RankingBadge",e.VLMInfo.RNK]),o.push([FIELD_MAPPING_VALUE,"#PM_WPHeading",e.VLMInfo["H@WP"]]),o.push([FIELD_MAPPING_TEXT,".BoatClass",e.VLMInfo.POL.substring(5)]),o.push([FIELD_MAPPING_TEXT,".RaceName",e.VLMInfo.RAN]);var i=new VLMPosition(e.VLMInfo.WPLON,e.VLMInfo.WPLAT);o.push([FIELD_MAPPING_VALUE,"#PM_Lat",i.Lat.Value]),o.push([FIELD_MAPPING_VALUE,"#PM_Lon",i.Lon.Value]),0===i.Lon.Value&&0===i.Lat.Value&&(i=e.GetNextWPPosition()),void 0!==i&&i?(o.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat",i.Lat.toString()]),o.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon",i.Lon.toString()])):(o.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat","N/A"]),o.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon","N/A"])),parseInt(e.VLMInfo.PIM,10)===PM_ANGLE?(o.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.PIP),1)]),o.push([FIELD_MAPPING_VALUE,"#PM_Angle",e.VLMInfo.PIP])):(o.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.TWA),1)]),o.push([FIELD_MAPPING_VALUE,"#PM_Angle",RoundPow(e.VLMInfo.TWA,1)])),FillFieldsFromMappingTable(o);var r="lime";e.VLMInfo.TWA>0&&(r="red"),$(".BoatWindAngle").css("color",r);var s=Math.round(100*(e.VLMInfo.TWD+180))/100,l=(Math.round(100*e.VLMInfo.TWS),e.VLMInfo.POL),u=Math.round(100*e.VLMInfo.HDG)/100,d=Math.round(100*e.VLMInfo.TWS)/100,c=Math.round(100*e.VLMInfo.ORT)/100;$("#ImgWindAngle").attr("src","windangle.php?wheading="+s+"&boatheading="+u+"&wspeed="+d+"&roadtoend="+c+"&boattype="+l+"&jvlm="+e.VLMInfo.NOW),$("#ImgWindAngle").css("transform","rotate("+s+"deg)"),$("#DeckImage").css("transform","rotate("+u+"deg)"),$(".PMActiveMode").css("display","none"),$(".BCPane").removeClass("active");var p=".ActiveMode_",h="";switch(e.VLMInfo.PIM){case"1":p+="Heading",h="BearingMode";break;case"2":p+="Angle",h="AngleMode";break;case"3":p+="Ortho",h="OrthoMode";break;case"4":p+="VMG",h="VMGMode";break;case"5":p+="VBVMG",h="VBVMGMode";break;default:VLMAlert("Unsupported VLM PIM Mode, expect the unexpected....","alert-info")}$(p).css("display","inline"),$("."+h).addClass("active"),$("#"+h).addClass("active"),UpdatePilotInfo(e),UpdatePolarImages(e)}}function FillFieldsFromMappingTable(e){for(var t in e)if(e[t])switch(e[t][0]){case FIELD_MAPPING_TEXT:$(e[t][1]).text(e[t][2]);break;case FIELD_MAPPING_VALUE:$(e[t][1]).val(e[t][2]);break;case FIELD_MAPPING_CHECK:$(e[t][1]).prop("checked",e[t][2]);break;case FIELD_MAPPING_IMG:$(e[t][1]).attr("src",e[t][2]);break;case FIELD_MAPPING_CALLBACK:e[t][2](e[t][1])}}function FillRaceInstructions(e){if(void 0!==e&&e){var t=!0;void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&(t=_CurPlayer.CurBoat.RaceInfo.idraces!==e.idraces),t?$("#DiscontinueRaceTab").addClass("hidden"):$("#DiscontinueRaceTab").removeClass("hidden");FillRaceInfoHeader(e),FillRaceWaypointList(e),InitPolar(e),$.get("/ws/raceinfo/exclusions.php?idr="+e.idraces+"&v="+e.VER,function(e){e&&e.success&&FillNSZList(e.Exclusions)})}}var PolarSliderInited=!1;function FillRaceInfoHeader(e){if(void 0!==e&&e){var t=[];t.push([FIELD_MAPPING_TEXT,".ICSRaceName",e.racename]),t.push([FIELD_MAPPING_TEXT,".RaceId",e.idraces]),t.push([FIELD_MAPPING_TEXT,".BoatType",e.boattype.substring(5)]),t.push([FIELD_MAPPING_TEXT,".VacFreq",parseInt(e.vacfreq,10)]),t.push([FIELD_MAPPING_TEXT,"#LockTime",parseInt(e.coastpenalty,10)/60]),t.push([FIELD_MAPPING_TEXT,"#EndRace",parseInt(e.firstpcttime,10)]),t.push([FIELD_MAPPING_TEXT,"#RaceStartDate",GetLocalUTCTime(1e3*parseInt(e.deptime,10),!0,!0)]),t.push([FIELD_MAPPING_TEXT,"#RaceLineClose",GetLocalUTCTime(1e3*parseInt(e.closetime,10),!0,!0)]),t.push([FIELD_MAPPING_IMG,"#RaceImageMap","/cache/racemaps/"+e.idraces+".png"]),FillFieldsFromMappingTable(t)}}function HandlePolarSpeedSlide(e,t,a){$("#PolarSpeedHandle").text(t.value),DrawPolar(a)}function DrawPolar(e){var t=$("#PolarCanvas")[0],a=25;PolarSliderInited&&(a=parseFloat($("#PolarSpeedHandle").text()));var n=PolarsManager.GetPolarLine(e.boattype,a,function(){DrawPolar(e)},null,1);if(n){PolarSliderInited||(InitSlider("PolarSpeedSlider","PolarSpeedHandle",0,60,a,function(t,a){HandlePolarSpeedSlide(t,a,e)}),PolarSliderInited=!0),t.width=$("#PolarCanvas").width(),t.height=t.width;var o,i,r=t.getContext("2d"),s=!0,l=Math.PI/n.length,u=t.width/2,d=t.width/2,c=PolarsManager.GetPolarMaxSpeed(e.boattype,a),p=0,h=!0;for(var P in r.beginPath(),r.lineWidth="1",r.strokeStyle="#FF0000",n)if(n[P]){var f=n[P],g=(P=parseInt(P,10))*l,L=u+d*f*Math.cos(g),M=3+d*f*Math.sin(g),m=Math.cos(g+0)*f;h&&m<=p?(r.stroke(),r.beginPath(),r.moveTo(o,i),r.strokeStyle="#FFFFFF",h=!1):!h&&m>=p&&(r.stroke(),r.beginPath(),r.moveTo(o,i),r.strokeStyle="#FF0000",h=!0),p=m,s?(r.moveTo(M,L),s=!1):r.lineTo(M,L),o=M,i=L}r.stroke(),r.beginPath(),r.lineWidth="1",r.strokeStyle="#00FF00",r.moveTo(3,0),r.lineTo(3,t.height),r.stroke(),r.moveTo(2,t.height/2),r.lineTo(3+t.width,t.height/2),r.stroke();var I=Math.round(c/5);I||(I=1);for(var C=1;I*C-1<=c;C++)r.beginPath(),r.strokeStyle="#7FFFFF",r.arc(3,u,d*C*I/c,Math.PI/2,1.5*Math.PI,!0),r.stroke(),r.strokeText(" "+I*C,4+I*d*C/c,u+10)}}function UpdatePolarImages(e){var t,a=e.VLMInfo.POL.substring(5),n="";for(t=0;t<=45;t+=15)n+='<li><img class="polaire" src="/scaledspeedchart.php?boattype=boat_'+a+"&amp;minws="+t+"&amp;maxws="+(t+15)+'&amp;pas=2" alt="speedchart"></li>';$("#PolarList").empty(),$("#PolarList").append(n)}function BackupFooTable(e,t,a){e.DOMBackup?void 0===$(t)[0]&&($(e.RestoreId).append(e.DOMBackup),console.log("Restored footable "+t)):(e.DOMBackup=$(t),e.RestoreId=a)}function UpdatePilotInfo(e){if(void 0!==e&&e&&!PilototoFt.DrawPending){BackupFooTable(PilototoFt,"#PilototoTable","#PilototoTableInsertPoint");var t=[];if(e&&e.VLMInfo&&e.VLMInfo.PIL&&e.VLMInfo.PIL.length>0){for(var a in e.VLMInfo.PIL)if(e.VLMInfo.PIL[a]){var n=GetPilototoTableLigneObject(e,a);t.push(n)}e.VLMInfo.PIL.length<MAX_PILOT_ORDERS?$("#AutoPilotAddButton").removeClass("hidden"):$("#AutoPilotAddButton").addClass("hidden")}PilototoFt.DrawPending=!0,PilototoFt.loadRows(t,!1),console.log("loaded pilototo table"),UpdatePilotBadge(e)}}function HandleReadyTable(e,t){console.log("Table ready"+t),t.DrawPending=!1,t.OnReadyTable&&t.OnReadyTable()}function HandlePagingComplete(e,t){var a,n={ft_class_myboat:"rnk-myboat",ft_class_friend:"rnk-friend",ft_class_oncoast:"rnk-oncoast",ft_class_racing:"rnk-racing",ft_class_locked:"rnk-locked",ft_class_dns:"rnk-dns"};for(var o in n)n[o]&&$("td").closest("tr").removeClass(n[o]);for(a in n)n[a]&&$('td:contains("'+a+'")').closest("tr").addClass(n[a]);t.DrawPending=!1}function HandleTableDrawComplete(e,t){if(console.log("TableDrawComplete "+t.id),t.DrawPending=!1,t===RankingFt)setTimeout(function(){DeferedGotoPage(e,t)},500);else if(t.CallbackPending)return void setTimeout(function(){t.CallbackPending(),t.CallbackPending=null},500)}function DeferedGotoPage(e,t){RankingFt.TargetPage&&(RankingFt.gotoPage(RankingFt.TargetPage),RankingFt.TargetPage=0),setTimeout(function(){DeferedPagingStyle(e,t)},200)}function DeferedPagingStyle(e,t){HandlePagingComplete(e,t)}function GetPilototoTableLigneObject(e,t){var a=e.VLMInfo.PIL[t],n=GetLocalUTCTime(1e3*a.TTS,!0,!0),o=GetPilotModeName(a.PIM);return t=parseInt(t,10)+1,$("#EditCellTemplate .PIL_EDIT").attr("pil_id",t),$("#DeleteCellTemplate .PIL_DELETE").attr("TID",a.TID).attr("pil_id",t),{date:n,PIM:o,PIP:a.PIP,Status:a.STS,Edit:$("#EditCellTemplate").first().html(),Delete:$("#DeleteCellTemplate").first().html()}}function ShowAutoPilotLine(e,t){var a="#PIL"+t,n=e.VLMInfo.PIL[t-1],o=new Date(1e3*n.TTS),i=GetPilotModeName(n.PIM);if(void 0===$(a)[0]);$(a)[0].attributes.TID=n.TID,SetSubItemValue(a,"#PIL_DATE",o),SetSubItemValue(a,"#PIL_PIM",i),SetSubItemValue(a,"#PIL_PIP",n.PIP),SetSubItemValue(a,"#PIL_STATUS",n.STS),$(a).show()}function GetPILIdParentElement(e){for(var t=e;;){if(void 0===t)return;if("id"in t.attributes){var a=t.attributes.id.value;if(4===a.length&&"PIL"===a.substring(0,3))return t}t=t.parentElement}}function HandlePilotEditDelete(e){var t=$(this)[0],a=t.attributes.class.value,n=_CurPlayer.CurBoat;parseInt(t.attributes.pil_id.value,10);"PIL_EDIT"===a?HandleOpenAutoPilotSetPoint(e):"PIL_DELETE"===a&&DeletePilotOrder(n,t.attributes.TID.value)}function GetPilotModeName(e){switch(parseInt(e,10)){case 1:return GetLocalizedString("autopilotengaged");case 2:return GetLocalizedString("constantengaged");case 3:return GetLocalizedString("orthoengaged");case 4:return GetLocalizedString("bestvmgengaged");case 5:return GetLocalizedString("vbvmgengaged");default:return"PIM ???"+e+"???"}}function SetSubItemValue(e,t,a){var n=$(e).find(t);n.length>0&&n.text(a)}function UpdatePilotBadge(e){var t,a=0;if(void 0!==e&&e){var n=e.VLMInfo.PIL;if(void 0!==n&&n&&n.length)for(t in n)"pending"===n[t].STS&&a++;a>0?($(".PilotOrdersBadge").show(),$(".PilotOrdersBadge").text(a)):$(".PilotOrdersBadge").hide()}}function MoveWPBoatControlerDiv(e){$(e).prepend($("#PM_WPMode_Div"))}function UpdatePrefsDialog(e){if(void 0===e)$("#BtnSetting").addClass("hidden");else if($("#BtnSetting").removeClass("hidden"),$("#pref_boatname").val(e.BoatName),void 0!==e.VLMInfo){SelectCountryDDFlag(e.VLMInfo.CNT);var t=SafeHTMLColor(e.VLMInfo.COL);$("#pref_boatcolor").val(t),$("#cp11").colorpicker({useAlpha:!1,format:!1,color:t})}}var RaceSorter=function(e,t){return e.CanJoin===t.CanJoin?e.deptime>t.deptime?-1:e.deptime===t.deptime?e.racename>t.racename?1:e.racename===t.racename?0:-1:1:e.CanJoin?1:-1};function LoadRacesList(){var e=_CurPlayer.CurBoat.IdBoat;$("#RaceListPanel").empty().append("<H4>...</H4>"),$.get("/ws/raceinfo/list.php?iduser="+e+"&v="+(new Date).getTime(),function(e){var t=e;$("#RaceListPanel").empty();var a=[];for(var n in t)t[n]&&a.push(t[n]);for(var o in a.sort(RaceSorter),a)a[o]&&AddRaceToList(a[o]);var i=0;$("#RaceListPanel .btn-group .btn-md").each(function(){$(this).height()>i&&(i=$(this).height())}),$("#RaceListPanel .btn-group .btn-md").height(i)})}function AddRaceToList(e){var t,a,n=$("#RaceListPanel").first();new Date(0);if(_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&_CurPlayer.CurBoat.RaceInfo.idraces&&(e.CanJoin=e.CanJoin&"0"===_CurPlayer.CurBoat.RaceInfo.idraces),e.CanJoin){var o=new Date;new Date(1e3*e.deptime)<=o?(t="CanJoinRace",a=GetLocalizedString("closerace")+" "+moment("/date("+1e3*e.closetime+")/").fromNow()):(t="CanJoinRaceNotStarted",a=GetLocalizedString("departuredate")+" "+moment("/date("+1e3*e.deptime+")/").fromNow())}else t="NoJoinRace";var i='<div class="raceheaderline panel panel-default '+t+'" )>  <div data-toggle="collapse" href="#RaceDescription'+e.idraces+'" class="panel-body collapsed " data-parent="#RaceListPanel" aria-expanded="false">    <div class="col-xs-12">      <div class="col-xs-3">        <img class="racelistminimap" src="/cache/minimaps/'+e.idraces+'.png" ></img>      </div>      <div class="col-xs-9">        <div class="col-xs-12">          <span ">'+e.racename+'          </span>        </div>        <div class="btn-group col-xs-12">          <button id="JoinRaceButton" type="button" class="'+(e.CanJoin?"":"hidden")+' btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("subscribe")+'          </button>          <button id="SpectateRaceButton" type="button" class="ShowRaceInSpectatorMode btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("Spectator")+'          </button>          <button type="button" class="ShowICSButton btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ic")+'          </button>          <button type="button" class="RankingButton btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ranking")+"          </button>        </div>      </div>    </div>"+(a?'    <div class="col-xs-12">       <span "> '+a+"       </span>    </div>":"")+'  </div>  <div id="RaceDescription'+e.idraces+'" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">    <div class="panel-body">      <div class="col-xs-12"><img class="img-responsive" src="/cache/racemaps/'+e.idraces+'.png" width="530px"></div>        <div class="col-xs-9"><p>'+GetLocalizedString("race")+" : "+e.racename+"</p>          <p>Départ : "+GetLocalUTCTime(1e3*e.deptime,!0,!0)+"</p>          <p>"+GetLocalizedString("boattype")+" : "+e.boattype.substring(5)+"</p>          <p>"+GetLocalizedString("crank")+" : "+e.vacfreq+"'</p>          <p>"+GetLocalizedString("locktime")+parseInt(e.coastpenalty,10)/60+" '</p>          <p>"+GetLocalizedString("closerace")+GetLocalUTCTime(1e3*e.closetime,!0,!0)+"</p>        </div>      </div>    </div>  </div>";n.prepend(i),$("#JoinRaceButton").click(function(e){EngageBoatInRace(e.currentTarget.attributes.idrace.value,_CurPlayer.CurBoat.IdBoat)})}function PageClock(){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat){var e=_CurPlayer.CurBoat;if(void 0!==e&&void 0!==e.RaceInfo){var t=GetRaceClock(e.RaceInfo,e.VLMInfo.UDT),a=$(".RaceChrono");t<0?a.removeClass("ChronoRaceStarted").addClass("ChronoRacePending"):a.addClass("ChronoRaceStarted").removeClass("ChronoRacePending"),$("#RefreshAge").text(moment(_CurPlayer.CurBoat.LastRefresh).fromNow());var n=new Date(1e3*e.VLMInfo.LUP),o=e.VLMInfo.VAC,i=o-(new Date-n)/1e3%o;i>=o-1&&100,$("#pbar_innerdivvac").css("width",+Math.round(i%60*100/60)+"px"),$("#pbar_innerdivmin").css("width",Math.round(i/o*100)+"px"),a.text(GetFormattedChronoString(t))}}}function GetRaceClock(e,t){var a=new Date,n=new Date(1e3*e.deptime);if(e.racetype&RACE_TYPE_RECORD){var o=parseInt(t,10);if(-1===o)return 0;var i=new Date(1e3*o);return Math.floor((a-i)/1e3)}return Math.floor((a-n)/1e3)}function DisplayCurrentDDSelectedBoat(e){$(".BoatDropDown:first-child").html("<span BoatID="+e.IdBoat+">"+GetBoatInfoLine(e,e.IdBoat in _CurPlayer.Fleet)+'</span><span class="caret"></span>')}function PadLeftZero(e){return e<100?("00"+e).slice(-2):e}function GetFormattedChronoString(e){if(e<0)e=-e;else if(0===e)return"--:--:--";var t=PadLeftZero(e%60),a=PadLeftZero(Math.floor(e/60)%60),n=PadLeftZero(Math.floor(e/3600)%24),o=PadLeftZero(Math.floor(e/3600/24)),i=n.toString()+":"+a.toString()+":"+t.toString();return o>0&&(i=o.toString()+" d "+i),i}function RefreshCurrentBoat(e,t,a){var n=$(".BoatDropDown > span");void 0!==n&&void 0!==n[0]&&("BoatId"in n[0].attributes||"boatid"in n[0].attributes)&&SetCurrentBoat(GetBoatFromIdu(n[0].attributes.BoatID.value),e,t,a)}function UpdateLngDropDown(){var e=GetCurrentLocale();$("#SelectionLanguageDropDown:first-child").html('<img class=" LngFlag" lang="'+e+'" src="images/lng-'+e+'.png" alt="'+e+'"><span class="caret"></span>')}var _CurAPOrder=null;function HandleOpenAutoPilotSetPoint(e){var t,a=e.target;if("id"in a.attributes)t=a.attributes.id.nodeValue;else{if(!("class"in a.attributes))return void VLMAlert("Something bad has happened reload this page....","alert-danger");t=a.attributes.class.nodeValue}switch(t){case"AutoPilotAddButton":_CurAPOrder=new AutoPilotOrder;break;case"PIL_EDIT":var n=parseInt(a.attributes.pil_id.value,10);_CurAPOrder=new AutoPilotOrder(_CurPlayer.CurBoat,n),$("#AutoPilotSettingForm").modal("show");break;default:return void VLMalert("Something bad has happened reload this page....","alert-danger")}RefreshAPDialogFields()}function RefreshAPDialogFields(){$("#AP_Time").data("DateTimePicker").date(_CurAPOrder.Date),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),$("#AP_PIP").val(_CurAPOrder.PIP_Value),$("#AP_WPLat").val(_CurAPOrder.PIP_Coords.Lat.Value),$("#AP_WPLon").val(_CurAPOrder.PIP_Coords.Lon.Value),$("#AP_WPAt").val(_CurAPOrder.PIP_WPAngle),UpdatePIPFields(_CurAPOrder.PIM)}function HandleDateChange(e){_CurAPOrder.Date=e.date}function HandleClickToSetWP(){SetWPPending=!0,WPPendingTarget="AP",$("#AutoPilotSettingForm").modal("hide")}function HandleAPModeDDClick(e){var t=e.target.attributes.PIM.value;_CurAPOrder.PIM=parseInt(t,10),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),UpdatePIPFields(_CurAPOrder.PIM)}function UpdatePIPFields(e){var t=!0;switch(e){case PM_HEADING:case PM_ANGLE:t=!0;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:t=!1}t?($(".AP_PIPRow").removeClass("hidden"),$(".AP_WPRow").addClass("hidden")):($(".AP_PIPRow").addClass("hidden"),$(".AP_WPRow").removeClass("hidden"))}function SaveBoatAndUserPrefs(e){var t={},a=!1,n=$("#SelectionThemeDropDown").attr("SelTheme");void 0!==n&&(VLM2Prefs.CurTheme=n),VLM2Prefs.Save(),ComparePrefString($("#pref_boatname")[0].value,_CurPlayer.CurBoat.BoatName)||(t.boatname=encodeURIComponent($("#pref_boatname")[0].value),a=!0),ComparePrefString($("#pref_boatcolor")[0].value,SafeHTMLColor(_CurPlayer.CurBoat.VLMInfo.COL))||(t.color=$("#pref_boatcolor")[0].value.substring(1),a=!0);var o=GetPrefSelFlag();ComparePrefString(o,_CurPlayer.CurBoat.VLMInfo.CNT)||(t.country=encodeURIComponent(o),a=!0),a&&void 0!==_CurPlayer&&_CurPlayer&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})}function GetPrefSelFlag(){return $("#CountryDropDown:first-child [flag]")[0].attributes.flag.value}function ComparePrefString(e,t){return e.toString()===t.toString()}function SelectCountryDDFlag(e){$("#CountryDropDown:first-child").html("<div>"+GetCountryDropDownSelectorHTML(e,!1)+'<span class="caret"></span></div>')}function ResetCollapsiblePanels(e){$(".collapse").collapse("hide")}function HandleBoatSelectionChange(e){ResetCollapsiblePanels();var t=GetBoatFromIdu($(e.target).closest("li").attr("BoatID"));void 0!==t&&t?(SetCurrentBoat(t,!0,!1),DisplayCurrentDDSelectedBoat(t)):VLMAlertDanger(GetLocalizedString("Error Reload"))}var LastMouseMoveCall=0,ShowEstTimeOutHandle=null;function HandleMapMouseMove(e){var t=e.latlng;if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.VLMInfo){var a=new VLMPosition(t.lng,t.lat),n=new VLMPosition(_CurPlayer.CurBoat.VLMInfo.LON,_CurPlayer.CurBoat.VLMInfo.LAT),o=_CurPlayer.CurBoat.GetNextWPPosition(),i=null,r=new Date-LastMouseMoveCall>300;if(VLM2Prefs.MapPrefs.EstTrackMouse&&r&&(i=_CurPlayer.CurBoat.GetClosestEstimatePoint(a),LastMouseMoveCall=new Date,clearTimeout(ShowEstTimeOutHandle),StartEstimateTimeout()),$("#MI_Lat").text(a.Lat.toString()),$("#MI_Lon").text(a.Lon.toString()),$("#MI_LoxoDist").text(n.GetLoxoDist(a,2)+" nM"),$("#MI_OrthoDist").text(n.GetOrthoDist(a,2)+" nM"),$("#MI_Loxo").text(n.GetLoxoCourse(a,2)+" °"),$("#MI_Ortho").text(n.GetOrthoCourse(a,2)+" °"),void 0!==o&&o?($("#MI_WPLoxoDist").text(o.GetLoxoDist(a,2)+" nM"),$("#MI_WPOrthoDist").text(o.GetOrthoDist(a,2)+" nM"),$("#MI_WPLoxo").text(o.GetLoxoCourse(a,2)+" °"),$("#MI_WPOrtho").text(o.GetOrthoCourse(a,2)+" °")):($("#MI_WPLoxoDist").text("--- nM"),$("#MI_WPOrthoDist").text("--- nM"),$("#MI_WPLoxo").text("--- °"),$("#MI_WPOrtho").text("--- °")),GribMgr){var s=moment("/date("+1e3*GribMgr.LastGribDate+")/").fromNow(),l=moment("/date("+1e3*GribMgr.TableTimeStamps[0]+")/"),u=moment("/date("+1e3*GribMgr.TableTimeStamps[GribMgr.TableTimeStamps.length-1]+")/"),d=moment.duration(u.diff(l));$("#MI_SrvrGribAge").text(s),$("#MI_LocalGribAge").text(GetLocalUTCTime(l.add(3.5,"h"),!0,!0)),$("#MI_LocalGribSpan").text(d.asHours()+" h"),(new Date).getTime()/1e3-l.local().unix()>34200?$("#GribLoadOK").addClass("GribNotOK"):$("#GribLoadOK").removeClass("GribNotOK")}r&&RefreshEstPosLabels(i)}}function StartEstimateTimeout(){ShowEstTimeOutHandle=setTimeout(function(){_CurPlayer.CurBoat.GetClosestEstimatePoint(null),RefreshEstPosLabels(null),DrawBoat(_CurPlayer.CurBoat,!1)},5e3)}function RefreshEstPosLabels(e){e&&void 0!==e.Date?$("#MI_EstDate").text(GetLocalUTCTime(e.Date,!1,!0)):$("#MI_EstDate").text("")}function GetWPrankingLI(e){return'<li id="RnkWP'+e.wporder+'" RnkSort="WP" WPRnk="'+e.wporder+'"><a href="#DivRnkRAC" RnkSort="WP" WPRnk="'+e.wporder+'">WP '+e.wporder+" : "+e.libelle+"</a></li>"}function ResetRankingWPList(e){$("[WPRnk]").remove(),$("#RnkTabsUL").addClass("WPNotInited")}function CheckWPRankingList(e,t){var a=$(".WPNotInited"),n=GetRankingRaceId(e),o=!1;if(void 0!==a&&a&&n)if(void 0!==e&&e&&void 0!==e.RaceInfo&&e.RaceInfo&&n===e.RaceInfo.RaceId)BuildWPTabList(void 0,a),o=!0;else if(t)BuildWPTabList(t,a),o=!0;else{var i=0;void 0!==e.VLMInfo&&(i=e.VLMInfo.VER),$.get("/ws/raceinfo/desc.php?idrace="+n+"&v="+i,function(t){CheckWPRankingList(e,t)})}o&&($(a).removeClass("WPNotInited"),$(".JVLMTabs").tabs("refresh"))}function BuildWPTabList(e,t){var a;if(void 0!==t&&t)for(a in void 0!==e&&e||(e=Boat.RaceInfo.races_waypoints),e.races_waypoints)if(e.races_waypoints[a]){var n=GetWPrankingLI(e.races_waypoints[a]);$(t).append(n)}}function SortRanking(e,t){var a=_CurPlayer.CurBoat;if(CheckWPRankingList(a),void 0!==a&&a){var n=null;switch(a.VLMPrefs&&a.VLMPrefs.mapPrefOpponents&&(n=a.VLMPrefs.mapPrefOpponents.split(",")),e){case"WP":SetRankingColumns(e),SortRankingData(a,e,t=parseInt(t,10)),FillWPRanking(a,t,n);break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetRankingColumns(e),SortRankingData(a,e),FillStatusRanking(a,e,n);break;default:SetRankingColumns("RAC"),SortRankingData(a,"RAC"),FillRacingRanking(a,n)}}}function SetRankingColumns(e){switch(e){case"WP":SetWPRankingColumns();break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetNRClassRankingColumns();break;default:SetRacingClassRankingColumns()}}var RACColumnHeader=["Rank","Name","Distance","Time","Loch","Lon","Lat","Last1h","Last3h","Last24h","Delta1st"],NRColumnHeader=["Rank","Name","Distance"],WPColumnHeader=["Rank","Name","Time","Loch"],RACColumnHeaderLabels=["ranking","boatname","distance","racingtime","Loch","Lon","Lat","Last1h","Last3h","Last24h","ecart"],NRColumnHeaderLabels=["ranking","boatname","status"],WPColumnHeaderLabels=["ranking","boatname","racingtime","ecart"];function SetRacingClassRankingColumns(){SetColumnsVisibility(RACColumnHeader,RACColumnHeaderLabels)}function SetNRClassRankingColumns(){SetColumnsVisibility(NRColumnHeader,NRColumnHeaderLabels)}function SetWPRankingColumns(){SetColumnsVisibility(WPColumnHeader,WPColumnHeaderLabels)}function SetColumnsVisibility(e,t){var a;for(a=0;a<RankingFt.columns.array.length;a++)if(RankingFt.columns.array[a]){var n=e.indexOf(RankingFt.columns.array[a].name);n>-1&&$("[data-name='"+e[n]+"']").attr("I18n",t[n]),RankingFt.columns.array[a].visible=n>-1}LocalizeItem($("[I18n][data-name]").get())}function RnkIsArrived(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatArrivedStatus.indexOf(e.status)}function RnkIsRacing(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatRacingStatus.indexOf(e.status)}function Sort2ArrivedBoats(e,t){var a=parseInt(e.duration,10)+parseInt(e.penalty,10),n=parseInt(t.duration,10)+parseInt(t.penalty,10);return a>n?(DebugRacerSort(e,t,1),1):a<n?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}function Sort2RacingBoats(e,t){var a=parseInt(e.nwp,10),n=parseInt(t.nwp,10);if(a===n){var o=parseFloat(e.dnm),i=parseFloat(t.dnm);if(o>i)return DebugRacerSort(e,t,1),1;if(o===i){DebugRacerSort(e,t,0);var r=e.country>t.country?1:e.country===t.country?0:-1;return r||(e.idusers>t.idusers?1:e.idusers===t.idusers?0:-1)}return DebugRacerSort(e,t,-1),-1}return a>n?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,1),1)}function GetWPDuration(e,t){return e&&e.WP&&e.WP[t-1]&&e.WP[t-1].duration?parseInt(e.WP[t-1].duration,10):9999999999}function WPRaceSort(e){return function(t,a){return GetWPDuration(t,e)-GetWPDuration(a,e)}}function RacersSort(e,t){return RnkIsRacing(e)&&RnkIsRacing(t)?Sort2RacingBoats(e,t):RnkIsArrived(e)&&RnkIsArrived(t)?Sort2ArrivedBoats(e,t):RnkIsArrived(e)?(DebugRacerSort(e,t,-1),-1):RnkIsArrived(t)?(DebugRacerSort(e,t,1),1):RnkIsRacing(e)?(DebugRacerSort(e,t,1),-1):RnkIsRacing(t)?(DebugRacerSort(e,t,1),1):Sort2NonRacing(e,t)}var AlertTemplate,DebugCount=1;function DebugRacerSort(e,t,a){}function Sort2NonRacing(e,t){if(void 0!==e.idusers&&void 0!==t.idusers){var a=e.country>t.country?1:e.country===t.country?0:-1;if(a)return a;var n=parseInt(e.idusers,10),o=parseInt(t.idusers,10);return n>o?(DebugRacerSort(e,t,1),1):n<o?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}if("undefined"!=typeof IdUser1)return-1;if("undefined"!=typeof IdUser2)return-1;var i=[e,t];return i.sort(),i[0]===e?1:-1}function GetRankingRaceId(e,t){return t||RankingFt.RaceRankingId?t||RankingFt.RaceRankingId:e.Engaged}function SortRankingData(e,t,a,n){if(n=GetRankingRaceId(e,n),e&&Rankings[n]){var o;if(Rankings&&Rankings[n]&&void 0===Rankings[n].RacerRanking)for(o in Rankings[n].RacerRanking=[],Rankings[n])Rankings[n][o]&&Rankings[n].RacerRanking.push(Rankings[n][o]);switch(t){case"WP":Rankings[n].RacerRanking.sort(WPRaceSort(a));break;case"RAC":case"DNF":case"HC":case"HTP":case"ABD":case"ARR":Rankings[n].RacerRanking.sort(RacersSort);break;default:VLMAlertInfo("unexpected sort option : "+t)}var i=1,r=0;for(r in Rankings[n].RacerRanking)if(Rankings[n].RacerRanking[r]&&e.IdBoat===r){i=r+1;break}return i}}function FillWPRanking(e,t,a){var n,o=1,i=0,r=[];if(e&&RankingFt&&!RankingFt.DrawPending){var s=GetRankingRaceId(e);for(n in BackupRankingTable(),Rankings[s].RacerRanking)if(Rankings[s].RacerRanking[n]){var l=Rankings[s].RacerRanking[n];l.WP&&l.WP[t-1]&&!l.WP[t-1].Delta&&(i?(l.WP[t-1].Delta=l.WP[t-1].duration-i,l.WP[t-1].Pct=100*(l.WP[t-1].duration/i-1)):(i=l.WP[t-1].duration,l.WP[t-1].Delta=0,l.WP[t-1].Pct=0)),l.WP&&l.WP[t-1]&&(r.push(GetRankingObject(l,parseInt(n,10)+1,t,a)),e.IdBoat===parseInt(l.idusers,10)&&(o=r.length))}var u=RoundPow(o/20,0)+(o%20>=10?0:1);RankingFt.DrawPending=!0,RankingFt.loadRows(r),RankingFt.TargetPage=u}}function BackupICS_WPTable(){BackupFooTable(ICS_WPft,"#RaceWayPoints","#RaceWayPointsInsertPoint")}function getWaypointHTMLSymbols(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+="&#x21BA; ";break;case WP_CROSS_CLOCKWISE:t+="&#x21BB; "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+="&#x2285; "),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+="&#x27F0;";break;case WP_ICE_GATE_N:t+="&#x27F1;"}return t.trim()}function getWaypointHTMLSymbolsDescription(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+=GetLocalizedString("Anti-clockwise")+" ";break;case WP_CROSS_CLOCKWISE:t+=GetLocalizedString("Clockwise")+" "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+=GetLocalizedString("Only once")),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("South")+") ";break;case WP_ICE_GATE_N:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("North")+") "}return""!==t&&(t=GetLocalizedString("Crossing")+" : "+t),t.trim()}function NormalizeRaceInfo(e){if(void 0!==e&&e&&!e.IsNormalized){for(var t in e.startlat/=VLM_COORDS_FACTOR,e.startlong/=VLM_COORDS_FACTOR,e.races_waypoints)if(e.races_waypoints[t]){var a=e.races_waypoints[t];a.latitude1/=VLM_COORDS_FACTOR,a.longitude1/=VLM_COORDS_FACTOR,void 0!==a.latitude2&&(a.latitude2/=VLM_COORDS_FACTOR,a.longitude2/=VLM_COORDS_FACTOR)}e.IsNormalized=!0}}function FillRaceWaypointList(e){if(ICS_WPft.DrawPending)ICS_WPft.CallbackPending||(ICS_WPft.CallbackPending=function(){FillRaceWaypointList(e)});else if(BackupICS_WPTable(),e){NormalizeRaceInfo(e);var t=[],a={WaypointId:0};for(var n in a.WP1=e.startlat+"<BR>"+e.startlong,a.WP2="",a.Spec="",a.Type=GetLocalizedString("startmap"),a.Name="",t.push(a),e.races_waypoints)if(e.races_waypoints[n]){var o=e.races_waypoints[n],i={};i.WaypointId=o.wporder,i.WP1=o.latitude1+"<BR>"+o.longitude1,void 0!==o.latitude2?i.WP2=o.latitude2+"<BR>"+o.longitude2:i.WP2="@"+o.laisser_au,i.Spec="<span title='"+getWaypointHTMLSymbolsDescription(o.wpformat)+"'>"+getWaypointHTMLSymbols(o.wpformat)+"</span>",i.Type=GetLocalizedString(o.wptype),i.Name=o.libelle,t.push(i)}ICS_WPft.loadRows(t)}}function BackupNSZ_Table(){BackupFooTable(NSZ_WPft,"NSZPoints","NSZPointsInsertPoint")}function FillNSZList(e){if(NSZ_WPft.DrawPending)NSZ_WPft.CallbackPending||(NSZ_WPft.CallbackPending=function(){FillNSZList(e)});else if(BackupNSZ_Table(),e){var t=[];for(var a in e)if(e[a]){var n=e[a],o={};o.NSZId=a,o.Lon1=n[0][1],o.Lat1=n[0][0],o.Lon2=n[1][1],o.Lat2=n[1][0],t.push(o)}NSZ_WPft.loadRows(t)}}function BackupRankingTable(){BackupFooTable(RankingFt,"#RankingTable","#my-rank-content")}function BackupVLMIndexTable(){BackupFooTable(VLMINdexFt,"#VLMIndexTable","#my-vlmindex-content")}function FillStatusRanking(e,t,a){var n,o=1,i=[],r=GetRankingRaceId(e);for(n in BackupRankingTable(),Rankings[r].RacerRanking)if(Rankings[r].RacerRanking[n]){var s=Rankings[r].RacerRanking[n];s.status===t&&(i.push(GetRankingObject(s,parseInt(n,10)+1,null,a)),e.IdBoat===parseInt(s.idusers,10)&&(o=i.length))}var l=RoundPow(o/20,0)+(o%20>=10?0:1);RankingFt.loadRows(i),RankingFt.TargetPage=l,RankingFt.DrawPending=!0}function FillRacingRanking(e,t){var a,n=[],o=0,i={Arrived1stTime:null,Racer1stPos:null};BackupRankingTable();var r=GetRankingRaceId(e),s=0;if(r&&void 0!==Rankings&&void 0!==Rankings[r]&&Rankings[r]&&Rankings[r].RacerRanking)for(a in Rankings[r].RacerRanking)if(Rankings[r].RacerRanking[a]){var l=Rankings[r].RacerRanking[a];if(e.IdBoat===parseInt(l.idusers,10)&&(o=n.length),!RnkIsArrived(l)&&!RnkIsRacing(l))break;!i.Arrived1stTime&&RnkIsArrived(l)&&(i.Arrived1stTime=parseInt(l.duration,10)),!RnkIsRacing(l)||i.Racer1stPos&&l.nwp===s||(i.Racer1stPos=l.dnm,s=l.nwp),n.push(GetRankingObject(l,parseInt(a,10)+1,null,t,i))}var u=RoundPow(o/20,0)+(o%20>=10?0:1);RankingFt.loadRows(n),RankingFt.TargetPage=u,RankingFt.DrawPending=!0}function GetBoatInfoLink(e){var t=parseInt(e.idusers,10),a=e.boatname,n="";return e.country&&void 0===(n=GetCountryFlagImgHTML(e.country))&&(n=""),n+='<a class="RaceHistLink" boatid ="'+t+'"data-toggle="tooltip" title="'+t+'" >'+a+"</a>"}function GetRankingObject(e,t,a,n,o){var i="";void 0!==e.Challenge&&e.Challenge[1]&&(i='<img class="RnkLMNH" src="images/LMNH.png"></img>'+i);var r={Rank:t,Name:i+=GetBoatInfoLink(e),Distance:"",Time:"",Loch:"",Lon:"",Lat:"",Last1h:"",Last3h:"",Last24h:"",Class:"",Delta1st:""};if(parseInt(e.idusers,10)===_CurPlayer.CurBoat.IdBoat&&(r.Class+=" ft_class_myboat"),void 0!==n&&n&&-1!==n.indexOf(e.idusers)&&(r.Class+=" ft_class_friend"),RnkIsRacing(e)&&!a){var s="["+e.nwp+"] -=> "+RoundPow(e.dnm,2);if(t>1&&o&&o.Racer1stPos){new VLMPosition(e.longitude,e.latitude);r.Delta1st=RoundPow(e.dnm-o.Racer1stPos,2)}r.Distance=s;var l=Math.round((new Date-new Date(1e3*parseInt(e.deptime,10)))/1e3);for(var u in r.Time="-1"===e.deptime?"":GetFormattedChronoString(l),r.Loch=e.loch,r.Lon=FormatLon(e.longitude),r.Lat=FormatLat(e.latitude),r.Last1h=e.last1h,r.Last3h=e.last3h,r.Last24h=e.last24h,BoatRacingStatus)e.status===BoatRacingStatus[u]&&(r.Class+="  "+BoatRacingClasses[BoatRacingStatus[u]])}else if(a){var d;if(r.Time=GetFormattedChronoString(parseInt(e.WP[a-1].duration,10)),e.WP[a-1].Delta){var c=RoundPow(e.WP[a-1].Pct,2);d=GetFormattedChronoString(e.WP[a-1].Delta)+" (+"+c+" %)"}else d=GetLocalizedString("winner");r.Loch=d}else{var p=GetLocalizedString("status_"+e.status);r.Distance=p;var h=parseInt(e.duration,10);r.Time=GetFormattedChronoString(h),o&&h!==o.Arrived1stTime?(r.Time+=" ( +"+RoundPow(h/o.Arrived1stTime*100-100,2)+"% )",r.Delta1st=GetFormattedChronoString(h-o.Arrived1stTime)):o&&h==o.Arrived1stTime&&(r.Delta1st=GetLocalizedString("winner")),r.Loch=e.loch}return r}function formatCoords(e){e=Math.abs(e);var t=Math.trunc(e);return t+"° "+Math.trunc(60*(e-t))+"' "+RoundPow(3600*(e-t)%60,4)+'"'}function FormatLon(e){var t=e>0?"W":"E";return formatCoords(e)+t}function FormatLat(e){var t=e>0?"N":"S";return formatCoords(e)+t}function HandleShowMapPrefs(e){$("#DisplayReals").attr("checked",VLM2Prefs.MapPrefs.ShowReals),$("#DisplayNames").attr("checked",VLM2Prefs.MapPrefs.ShowOppNumbers),$("#EstTrackMouse").attr("checked",VLM2Prefs.MapPrefs.EstTrackMouse),$("#TrackEstForecast").attr("checked",VLM2Prefs.MapPrefs.TrackEstForecast),$("#UseUTC").attr("checked",VLM2Prefs.MapPrefs.UseUTC),$("#DDMapSelOption:first-child").html("<span Mode="+VLM2Prefs.MapPrefs.MapOppShow+">"+VLM2Prefs.MapPrefs.GetOppModeString(VLM2Prefs.MapPrefs.MapOppShow)+'</span><span class="caret"></span>'),VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTop10?($("#NbDisplayBoat").removeClass("hidden"),$("#NbDisplayBoat").val(VLM2Prefs.MapPrefs.ShowTopCount)):$("#NbDisplayBoat").addClass("hidden"),$("#VacPol").val(VLM2Prefs.MapPrefs.PolarVacCount)}function HandleMapPrefOptionChange(e){var t=e.target;if(void 0!==t&&void 0!==t.attributes.id){var a=t.attributes.id.value,n=t.checked;switch(a){case"DisplayReals":case"ShowReals":case"UseUTC":case"DisplayNames":case"ShowOppNumbers":case"EstTrackMouse":case"TrackEstForecast":VLM2Prefs.MapPrefs[a]=n;break;case"VacPol":var o=parseInt($("#VacPol").val(),10);o>0&&o<120?VLM2Prefs.MapPrefs.PolarVacCount=o:$("#VacPol").value(12);break;case"NbDisplayBoat":var i=parseInt($("#NbDisplayBoat").val(),10);VLM2Prefs.MapPrefs.ShowTopCount=i;break;default:return void console.log("unknown pref storage called : "+a)}VLM2Prefs.Save(),RefreshCurrentBoat(!1,!1)}}function SafeHTMLColor(e){return(e=""+e).length<6&&(e=("000000"+e).slice(-6)),"#"!==e.substring(0,1)?e="#"+e:"#"===e.substring(1,2)&&(e=e.substring(1)),e}function HandleMapOppModeChange(e){var t=e.target;if(void 0!==t&&t&&void 0!==t.attributes&&"undefined"!==t.attributes.Mode&&t.attributes.Mode){var a=parseInt(t.attributes.Mode.value,10);VLM2Prefs.MapPrefs.MapOppShow=a,VLM2Prefs.Save(),HandleShowMapPrefs(e)}}function SetActiveStyleSheet(e){var t,a;for(t=0;a=document.getElementsByTagName("link")[t];t++)-1!==a.getAttribute("rel").indexOf("style")&&a.getAttribute("title")&&(a.disabled=!0,a.getAttribute("title")===e&&(a.disabled=!1))}function SetDDTheme(e){SetActiveStyleSheet(e),$("#SelectionThemeDropDown:first-child").html(e+'<span class="caret"></span>'),$("#SelectionThemeDropDown").attr("SelTheme",e)}function HandleDDlineClick(e){e.target;SetDDTheme(e.target.attributes.ddtheme.value)}function InitAlerts(){$("#AlertBox").css("display","block"),AlertTemplate=$("#AlertBox")[0],$("#AlertBoxContainer").empty(),$("#AlertBoxContainer").removeClass("hidden")}function VLMAlertSuccess(e){VLMAlert(e,"alert-success")}function VLMAlertDanger(e){VLMAlert(e,"alert-danger")}function VLMAlertInfo(e){VLMAlert(e,"alert-info")}var AlertIntervalId=null;function VLMAlert(e,t){AlertIntervalId&&clearInterval(AlertIntervalId),void 0!==t&&t||(t="alert-info"),$("#AlertBoxContainer").empty().append(AlertTemplate).show(),$("#AlertText").text(e),$("#AlertBox").removeClass("alert-sucess"),$("#AlertBox").removeClass("alert-warning"),$("#AlertBox").removeClass("alert-info"),$("#AlertBox").removeClass("alert-danger"),$("#AlertBox").addClass(t),$("#AlertBox").show(),$("#AlertCloseBox").unbind().on("click",AutoCloseVLMAlert),AlertIntervalId&&clearInterval(AlertIntervalId),AlertIntervalId=setTimeout(AutoCloseVLMAlert,5e3)}function AutoCloseVLMAlert(){$("#AlertBox").hide()}function GetUserConfirmation(e,t,a){$("#ConfirmDialog").modal("show"),t?($("#OKBtn").hide(),$("#CancelBtn").hide(),$("#YesBtn").show(),$("#NoBtn").show()):($("#OKBtn").show(),$("#CancelBtn").show(),$("#YesBtn").hide(),$("#NoBtn").hide()),$("#ConfirmText").text(e),$(".OKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!0)}),$(".NOKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!1)})}function GetRaceRankingLink(e){return'<a href="/jvlm?RaceRank='+e.idrace+'" target="RankTab">'+e.racename+"</a>"}function FillBoatPalmares(e,t,a,n,o,i){var r;if("success"===t){var s=[];for(r in e.palmares)if(e.palmares[r]){var l=e.palmares[r],u={RaceId:e.palmares[r].idrace,RaceName:GetRaceRankingLink(e.palmares[r]),Ranking:l.ranking.rank+" / "+l.ranking.racercount};s.push(u)}RaceHistFt.loadRows(s)}var d=GetLocalizedString("palmares");d=d.replace("%s",e.boat.name),$("#palmaresheaderline").text(d)}function ShowUserRaceHistory(e){$("#RaceHistory").modal("show"),$.get("/ws/boatinfo/palmares.php?idu="+e,function(e,t,a,n,o,i){FillBoatPalmares(e,t,a,n,o,i)})}function HandleShowBoatRaceHistory(e){var t=$(e.target).attr("boatid");t&&ShowUserRaceHistory(t)}function HandleCreateUserResult(e,t){if("success"===t&&e)if($(".ValidationMark").addClass("hidden"),e.success?($(".ValidationMark.Valid").removeClass("hidden"),VLMAlertSuccess(GetLocalizedString("An email has been sent. Click on the link to validate.")),$("#InscriptForm").modal("hide"),$("#LoginForm").modal("hide")):e.request&&e.request.errorstring?VLMAlertDanger(GetLocalizedString(e.request.errorstring)):VLMAlertDanger(GetLocalizedString(e.error.msg)),e.request)e.request.MailOK?$(".ValidationMark.Email.Valid").removeClass("hidden"):$(".ValidationMark.Email.Invalid").removeClass("hidden"),e.request.PasswordOK?$(".ValidationMark.Password.Valid").removeClass("hidden"):$(".ValidationMark.Password.Invalid").removeClass("hidden"),e.request.PlayerNameOK?$(".ValidationMark.Pseudo.Valid").removeClass("hidden"):$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");else if(e.error)switch(e.error.code){case"NEWPLAYER01":$(".ValidationMark.Email.Invalid").removeClass("hidden");break;case"NEWPLAYER02":$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");break;case"NEWPLAYER03":$(".ValidationMark.Password.Invalid").removeClass("hidden")}$("#BtnCreateAccount").show()}function HandleCreateUser(){var e=$("#NewPlayerPseudo")[0].value,t={emailid:$("#NewPlayerEMail")[0].value,password:$("#NewPlayerPassword")[0].value,pseudo:e};$("#BtnCreateAccount").hide(),$.post("/ws/playerinfo/player_create.php",t,function(e,t){HandleCreateUserResult(e,t)})}function setModalMaxHeight(e){var t=$(e),a=t.find(".modal-content"),n=a.outerHeight()-a.innerHeight(),o=$(window).width()<768?20:60,i=$(window).height()-(o+n)-((t.find(".modal-header").outerHeight()||0)+(t.find(".modal-footer").outerHeight()||0));a.css({overflow:"hidden"}),t.find(".modal-body").css({"max-height":i,"overflow-y":"auto"})}function GetLocalUTCTime(e,t,a){var n=e,o="";return moment.isMoment(e)||(n=t?moment(e).utc():moment(e)),VLM2Prefs.MapPrefs.UseUTC?(n.isLocal()&&(n=n.utc()),o=" Z"):n.isLocal()||(n=n.local()),a?n.format("LLLL")+o:n}if("undefined"==typeof jQuery)throw new Error("jQuery progress timer requires jQuery");!function(e,t,a,n){var o="progressTimer",i={timeLimit:60,warningThreshold:5,onFinish:function(){},baseStyle:"",warningStyle:"progress-bar-danger",completeStyle:"progress-bar-success",showHtmlSpan:!0,errorText:"ERROR!",successText:"100%"},r=function(t,a){this.element=t,this.$elem=e(t),this.options=e.extend({},i,a),this._defaults=i,this._name=o,this.metadata=this.$elem.data("plugin-options"),this.init()};r.prototype.constructor=r,r.prototype.init=function(){var a=this;return e(a.element).empty(),a.span=e("<span/>"),a.barContainer=e("<div>").addClass("progress"),a.bar=e("<div>").addClass("progress-bar active progress-bar-striped").addClass(a.options.baseStyle).attr("role","progressbar").attr("aria-valuenow","0").attr("aria-valuemin","0").attr("aria-valuemax",a.options.timeLimit),a.span.appendTo(a.bar),a.options.showHtmlSpan||a.span.addClass("sr-only"),a.bar.appendTo(a.barContainer),a.barContainer.appendTo(a.element),a.start=new Date,a.limit=1e3*a.options.timeLimit,a.warningThreshold=1e3*a.options.warningThreshold,a.interval=t.setInterval(function(){a._run.call(a)},250),a.bar.data("progress-interval",a.interval),!0},r.prototype.destroy=function(){this.$elem.removeData()},r.prototype._run=function(){var e=this,t=new Date-e.start,a=t/e.limit*100;e.bar.attr("aria-valuenow",a),e.bar.width(a+"%");var n=a.toFixed(2);return n>=100&&(n=100),e.options.showHtmlSpan&&e.span.html(n+"%"),t>=e.warningThreshold&&e.bar.removeClass(this.options.baseStyle).removeClass(this.options.completeStyle).addClass(this.options.warningStyle),t>=e.limit&&e.complete.call(e),!0},r.prototype.removeInterval=function(){var a=e(".progress-bar",this.element);if(void 0!==a.data("progress-interval")){var n=a.data("progress-interval");t.clearInterval(n)}return a},r.prototype.complete=function(){var t=this,a=t.removeInterval.call(t),n=arguments;0!==n.length&&"object"===_typeof(n[0])&&(t.options=e.extend({},t.options,n[0])),a.removeClass(t.options.baseStyle).removeClass(t.options.warningStyle).addClass(t.options.completeStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.successText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},r.prototype.error=function(){var t=this,a=t.removeInterval.call(t),n=arguments;0!==n.length&&"object"===_typeof(n[0])&&(t.options=e.extend({},t.options,n[0])),a.removeClass(t.options.baseStyle).addClass(t.options.warningStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.errorText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},e.fn[o]=function(t){var a=arguments;if(t===n||"object"===_typeof(t))return this.each(function(){e.data(this,"plugin_"+o)||e.data(this,"plugin_"+o,new r(this,t))});if("string"==typeof t&&"_"!==t[0]&&"init"!==t){if(0===Array.prototype.slice.call(a,1).length&&-1!==e.inArray(t,e.fn[o].getters)){var i=e.data(this[0],"plugin_"+o);return i[t].apply(i,Array.prototype.slice.call(a,1))}return this.each(function(){var n=e.data(this,"plugin_"+o);n instanceof r&&"function"==typeof n[t]&&n[t].apply(n,Array.prototype.slice.call(a,1))})}},e.fn[o].getters=["complete","error"]}(jQuery,window,document,void 0),function(e){if(e.support.touch="ontouchend"in document,e.support.touch){var t,a=e.ui.mouse.prototype,n=a._mouseInit,o=a._mouseDestroy;a._touchStart=function(e){!t&&this._mouseCapture(e.originalEvent.changedTouches[0])&&(t=!0,this._touchMoved=!1,i(e,"mouseover"),i(e,"mousemove"),i(e,"mousedown"))},a._touchMove=function(e){t&&(this._touchMoved=!0,i(e,"mousemove"))},a._touchEnd=function(e){t&&(i(e,"mouseup"),i(e,"mouseout"),this._touchMoved||i(e,"click"),t=!1)},a._mouseInit=function(){this.element.bind({touchstart:e.proxy(this,"_touchStart"),touchmove:e.proxy(this,"_touchMove"),touchend:e.proxy(this,"_touchEnd")}),n.call(this)},a._mouseDestroy=function(){this.element.unbind({touchstart:e.proxy(this,"_touchStart"),touchmove:e.proxy(this,"_touchMove"),touchend:e.proxy(this,"_touchEnd")}),o.call(this)}}function i(e,t){if(!(e.originalEvent.touches.length>1)){e.preventDefault();var a=e.originalEvent.changedTouches[0],n=document.createEvent("MouseEvents");n.initMouseEvent(t,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(n)}}}(jQuery);var _LocaleDict,_EnDict,BuoyMarker=L.Icon.extend({options:{iconSize:[36,72],iconAnchor:[18,36],popupAnchor:[0,-36]}}),TrackWPMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],iconUrl:"images/WP_Marker.gif",draggable:!0}}),BoatMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],iconUrl:"images/target.png",rotationOrigin:[24,24]}}),IceGateMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,-18],iconUrl:"images/icegate.png"}}),GateDirMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],rotationOrigin:[24,24]}});function GetBuoyMarker(e){var t=null;return(t=new BuoyMarker(e?{iconUrl:"images/Buoy1.png"}:{iconUrl:"images/Buoy2.png"})).IsCWBuoy=e,t}function GetBoatMarker(){return new BoatMarker}function GetTrackWPMarker(){return new TrackWPMarker}function GetGateTypeMarker(e,t){return t?IceGateMarker:new GateDirMarker({iconUrl:"images/"+e})}function GetOpponentMarker(e){return new L.Icon({iconUrl:"images/opponent"+e.IsTeam+".png",iconAnchor:[e.IsFriend/2,e.IsFriend/2],iconSize:[e.IsFriend,e.IsFriend]})}function ClearCurrentMapMarker(e){e&&e.RaceMapFeatures&&RemoveFromMap(e.RaceMapFeatures)}function EnsureMarkersVisible(e){e&&RestoreMarkersOnMap(e.RaceMapFeatures)}function RestoreMarkersOnMap(e){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var t in e)RestoreMarkersOnMap(e[t]);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var a in e)RestoreMarkersOnMap(e[a]);else e._leaflet_id&&!e._map&&e.addTo(map)}function RemoveFromMap(e){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var t in e)RemoveFromMap(e[t]);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var a in e)RemoveFromMap(e[a]);else e._leaflet_id&&e.removeFrom(map)}!function(){var e=L.Marker.prototype._initIcon,t=L.Marker.prototype._setPos,a="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var e=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;e&&(e=e[0]+"px "+e[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||e||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(e){e.target._applyRotation()})}),L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(e){t.call(this,e),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,a?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(e){return this.options.rotationAngle=e,this.update(),this},setRotationOrigin:function(e){return this.options.rotationOrigin=e,this.update(),this}})}();var _CurLocale="en";function LocalizeString(){return LocalizeItem($("[I18n]").get()),$(".LngFlag").click(function(e,t){OnLangFlagClick($(this).attr("lang")),UpdateLngDropDown()}),!0}function OnLangFlagClick(e){InitLocale(e)}function LocalizeItem(e){try{var t;for(t in e){var a=e[t],n=a.attributes.I18n.value;void 0!==_LocaleDict&&(a.innerHTML=GetLocalizedString(n))}}finally{}return!0}function InitLocale(e){var t="/ws/serverinfo/translation.php";e&&(t+="?lang="+e),$.get(t,function(e){1==e.success?(_CurLocale=e.request.lang,_LocaleDict=e.strings,moment.locale(_CurLocale),LocalizeString(),UpdateLngDropDown()):alert("Localization string table load failure....")}),void 0===_EnDict&&$.get("/ws/serverinfo/translation.php?lang=en",function(e){1==e.success?_EnDict=e.strings:alert("Fallback localization string table load failure....")})}function HTMLDecode(e){var t=document.createElement("textarea");t.innerHTML=e;var a=t.value,n=["\n\r","\r\n","\n","\r"];for(var o in n)for(;n[o]&&-1!==a.indexOf(n[o]);)a=a.replace(n[o],"<br>");return a}function GetLocalizedString(e){return void 0!==_LocaleDict&&_LocaleDict&&e in _LocaleDict?HTMLDecode(_LocaleDict[e]):void 0!==_EnDict&&_EnDict&&e in _EnDict?HTMLDecode(_EnDict[e]):e}function GetCurrentLocale(){return _CurLocale}var VLMMercatorTransform=new MercatorTransform;function MercatorTransform(){this.Width=1e4,this.Height=1e4,this.LonOffset=0,this.LatOffset=0,this.Scale=1e4/180,this.LonToMapX=function(e){return this.Width/2+(e-this.LonOffset)*this.Scale},this.LatToMapY=function(e){return e=Deg2Rad(e),e=Rad2Deg(e=Math.log(Math.tan(e)+1/Math.cos(e))),this.Height/2-(e-this.LatOffset)*this.Scale},this.SegmentsIntersect=function(e,t){var a=this.LonToMapX(e.P1.Lon.Value),n=this.LatToMapY(e.P1.Lat.Value),o=this.LonToMapX(e.P2.Lon.Value),i=this.LatToMapY(e.P2.Lat.Value),r=this.LonToMapX(t.P1.Lon.Value),s=this.LatToMapY(t.P1.Lat.Value),l=this.LonToMapX(t.P2.Lon.Value),u=this.LatToMapY(t.P2.Lat.Value);if(e.P1.Lon.Value===e.P2.Lon.Value&&e.P1.Lat.Value===e.P2.Lat.Value||t.P1.Lon.Value===t.P2.Lon.Value&&t.P1.Lat.Value===t.P2.Lat.Value)return!1;o-=a,i-=n,r-=a,s-=n,l-=a,u-=n,a=0,n=0;var d=Math.sqrt(o*o+i*i),c=o/d,p=i/d,h=r*c+s*p;if(s=s*c-r*p,r=h,h=l*c+u*p,u=u*c-l*p,l=h,s===u)return!1;var P=l+(r-l)*u/(u-s),f=P/d;if(f>=0&&f<=1){var g,L=n;if(l-r)g=(a+P-r)/(l-r);else{if(!(u-s))return!1;g=(L-s)/(u-s)}return g>=0&&g<=1}return!1}}var PolarsManager=new PolarManagerClass;function PolarManagerClass(){this.Polars=[],this.Init=function(){this.Polars=[],$.get("/ws/polarlist.php",function(e){for(var t in e.list)PolarsManager.Polars["boat_"+e.list[t]]=null})},this.GetBoatSpeed=function(e,t,a,n){if(!(e in this.Polars))return NaN;if(this.Polars[e]){var o=WindAngle(n,a);return GetPolarAngleSpeed(this.Polars[e],o,t)}return $.get("/Polaires/"+e+".csv",this.HandlePolarLoaded.bind(this,e,null,null)),NaN},this.HandlePolarLoaded=function(e,t,a,n){var o=$.csv.toArrays(n,{separator:";"});for(var i in o)if(o[i])for(var r in o[i])o[i][r]&&(o[i][r]=parseFloat(o[i][r]));PolarsManager.Polars[e]={},PolarsManager.Polars[e].SpeedPolar=o,PolarsManager.Polars[e].WindLookup=[],PolarsManager.Polars[e].AngleLookup=[],t&&a?t(a):t&&t()},this.GetPolarLine=function(e,t,a,n,o){if(o||(o=5),void 0===this.Polars[e])return alert("Unexpected polarname : "+e),null;if(null!==this.Polars[e]){var i,r=[],s=0;for(i=0;i<=180;i+=o){var l=GetPolarAngleSpeed(this.Polars[e],i,t);s<l&&(s=l),r.push(l)}for(var u in r)r[u]&&(r[u]/=s);return r}$.get("/Polaires/"+e+".csv",this.HandlePolarLoaded.bind(this,e,a,n))};var e=0;this.GetVMGCourse=function(t,a,n,o,i){for(var r=o.GetOrthoCourse(i),s=0,l=-1e10,u=-1;u<=1;u+=2)for(var d=0;d<=90;d+=.1){var c=this.GetBoatSpeed(t,a,n,r+d*u),p=c*Math.cos(Deg2Rad(d));e&&console.log("VMG "+RoundPow((r+d*u+360)%360,3)+" "+RoundPow(c,3)+" "+RoundPow(p,3)+" "+RoundPow(l,3)+" "+(p>=l?"BEST":"")),p>=l&&(l=p,s=r+d*u)}return e=0,s},this.GetVBVMGCourse=function(e,t,a,n,o){var i=n.GetOrthoDist(o),r=n.GetOrthoCourse(o),s=0,l=0,u=0,d=0,c=0,p=1,h=this.GetBoatSpeed(e,t,a,r);c=h>0?i/h:8760;var P=a-r;P<-90?P+=360:P>90&&(P-=360),p=P>0?-1:1;for(var f=1;f<=90;f++){var g=f*Math.PI/180,L=Math.tan(g),M=Math.sqrt(1+L*L),m=this.GetBoatSpeed(e,t,a,r-f*p);if(isNaN(m))throw"Nan SpeedT1 exception";if(m>0)for(var I=-89;I<=0;I++){var C=I*Math.PI/180,v=i*(Math.tan(-C)/(L+Math.tan(-C))),R=v*M/m;if(!(R<0||R>c)){var S=i-v,_=this.GetBoatSpeed(e,t,a,r-I*p);if(isNaN(_))throw"Nan SpeedT2 exception";if(!(_<=0)){var k=Math.tan(-C),T=R+S*Math.sqrt(1+k*k)/_;T<c&&(c=T,s=f,l=I,u=m,d=_)}}}}var b=u*Math.cos(Deg2Rad(s)),D=d*Math.cos(Deg2Rad(l));if(isNaN(b)||isNaN(D))throw"NaN VMG found";return b>D?r-s*p:r-l*p},this.GetPolarMaxSpeed=function(e,t){if(!this.Polars[e])return null;var a,n=0;for(a=0;a<=180;a+=1){var o=GetPolarAngleSpeed(this.Polars[e],a,t);o>n&&(n=o)}return n}}function GetPolarAngleSpeed(e,t,a){var n,o,i,r,s=e.SpeedPolar,l=Math.floor(a);if(void 0!==e.WindLookup&&l in e.WindLookup)n=e.WindLookup[l];else for(var u in s[0]){if(u>0&&s[0][u]>a)break;e.WindLookup[l]=Math.floor(u),n=Math.floor(u)}for(o=n<s[0].length-1?n+1:n;t<0;)t+=360;t>=360&&(t%=360),t>180&&(t=360-t);var d=Math.floor(t);if(void 0!==e.AngleLookup&&d in e.AngleLookup)i=e.AngleLookup[d];else for(var c in s){if(c>0&&s[c][0]>t)break;e.AngleLookup[d]=Math.floor(c),i=Math.floor(c)}r=i<s.length-1?i+1:i;var p=GetAvgValue(a,s[0][n],s[0][o],s[i][n],s[i][o]),h=GetAvgValue(a,s[0][n],s[0][o],s[r][n],s[r][o]),P=GetAvgValue(t,s[i][0],s[r][0],p,h);if(isNaN(P))throw"GetAvgValue was NaN";return P}function WindAngle(e,t){return e>=t?e-t<=180?e-t:360-e+t:t-e<=180?t-e:360-t+e}function GetAvgValue(e,t,a,n,o){return e===t||t===a||n===o?n:n+(e-t)/(a-t)*(o-n)}var _IsLoggedIn,POS_FORMAT_DEFAULT=0,EARTH_RADIUS=3443.84,VLM_DIST_ORTHO=1;function Deg2Rad(e){return e/180*Math.PI}function Rad2Deg(e){return e/Math.PI*180}function RoundPow(e,t){if(void 0!==t){var a=Math.pow(10,t);return Math.round(e*a)/a}return e}function NormalizeLongitudeDeg(e){return e<-180?e+=360:e>180&&(e-=360),e}function VLMPosition(e,t,a){void 0!==a&&a!=POS_FORMAT_DEFAULT||(this.Lon=new Coords(e,1),this.Lat=new Coords(t,0)),this.toString=function(e){return this.Lat.toString(e)+" "+this.Lon.toString(e)},this.GetEuclidianDist2=function(e){var t=(this.Lat.Value-e.Lat.Value)%90,a=(this.Lon.Value-e.Lon.Value)%180;return t*t+a*a},this.GetLoxoDist=function(e,t){var a,n=Deg2Rad(this.Lat.Value),o=Deg2Rad(e.Lat.Value),i=-Deg2Rad(this.Lon.Value),r=-Deg2Rad(e.Lon.Value),s=0;return s=Math.abs(o-n)<Math.sqrt(1e-15)?Math.cos(n):(o-n)/Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),a=Math.sqrt(Math.pow(o-n,2)+s*s*(r-i)*(r-i)),RoundPow(EARTH_RADIUS*a,t)},this.ReachDistLoxo=function(e,t){var a=0,n=0;if(isNaN(t))throw"unsupported reaching NaN distance";"number"==typeof e?(a=Deg2Rad(e/60),n=Deg2Rad(t%360)):(a=this.GetLoxoDist(e)/EARTH_RADIUS*t,n=Deg2Rad(this.GetLoxoCourse(e)));var o=Deg2Rad(this.Lat.Value),i=Deg2Rad(this.Lon.Value),r=0,s=0,l=(o+(r=o+a*Math.cos(n)))/2;if((s=i+a*Math.sin(n)/Math.cos(l))>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI),isNaN(s)||isNaN(r))throw"Reached Nan Position!!!";return s=Rad2Deg(s),r=Rad2Deg(r),new VLMPosition(NormalizeLongitudeDeg(s),r)},this.GetLoxoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),n=-Deg2Rad(e.Lon.Value),o=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=(n-a)%(2*Math.PI),s=(a-n)%(2*Math.PI),l=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(o/2+Math.PI/4));return RoundPow((720-(r<s?Math.atan2(r,l)%(2*Math.PI):Math.atan2(-s,l)%(2*Math.PI))/Math.PI*180)%360,t)},VLM_DIST_ORTHO?(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),n=-Deg2Rad(e.Lon.Value),o=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);return void 0!==t&&"number"==typeof t||(t=17),RoundPow(60*Rad2Deg(Math.acos(Math.sin(o)*Math.sin(i)+Math.cos(o)*Math.cos(i)*Math.cos(a-n))),t)},this.GetOrthoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),n=-Deg2Rad(e.Lon.Value),o=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=Deg2Rad(this.GetOrthoDist(e)/60),s=(Math.sin(i)-Math.sin(o)*Math.cos(r))/(Math.sin(r)*Math.cos(o));return RoundPow(s=Rad2Deg((s=s>=-1&&s<=1?Math.sin(n-a)<0?Math.acos(s):2*Math.PI-Math.acos(s):o<i?0:Math.PI)%(2*Math.PI)),t)}):(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),n=-Deg2Rad(e.Lon.Value),o=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=2*Math.asin(Math.sqrt(Math.pow(Math.sin((o-i)/2),2)+Math.pow(Math.cos(o)*Math.cos(i)*Math.sin((a-n)/2),2)));return RoundPow(EARTH_RADIUS*r,t)},this.GetOrthoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),n=-Deg2Rad(e.Lon.Value),o=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=Math.atan2(Math.sin(a-n)*Math.cos(i),Math.cos(o)*Math.sin(i)-Math.sin(o)*Math.cos(i)*Math.cos(a-n));return RoundPow(r=Rad2Deg(r%(2*Math.PI)),t)}),this.ReachDistOrtho=function(t,a){var n,o,i=t/EARTH_RADIUS,r=Deg2Rad(a),s=Deg2Rad(this.Lat.Value),l=Deg2Rad(-this.Lon.Value);return n=Math.asin(Math.sin(s)*Math.cos(i)+Math.cos(s)*Math.sin(i)*Math.cos(r)),o=Math.atan2(Math.sin(r)*Math.sin(i)*Math.cos(s),Math.cos(i)-Math.sin(s)*Math.sin(n)),new VLMPosition(NormalizeLongitudeDeg(Rad2Deg(-(e=(l-o+Math.PI)%(2*Math.PI)-Math.PI))),Rad2Deg(n))},this.GetVLMString=function(){return this.Lat.toString()+","+this.Lon.toString()}}function Boat(e){this.IdBoat=-1,this.Engaged=!1,this.BoatName="",this.BoatPseudo="",this.VLMInfo={},this.RaceInfo={},this.Exclusions=[],this.Track=[],this.RnkObject={},this.OppTrack=[],this.OppList=[],this.Reals=[],this.VLMPrefs=[],this.NextServerRequestDate=null,this.Estimator=new Estimator(this),this.EstimatePos=null,void 0!==e&&(this.IdBoat=e.idu,this.Engaged=e.engaged,this.BoatName=e.boatname,this.BoatPseudo=e.boatpseudo,this.VLMInfo=e.VLMInfo,this.RaceInfo=e.RaceInfo,this.Exclusions=e.Exclusions,this.Track=e.Track,this.RnkObject=e.RnkObject),this.GetNextGateSegment=function(e){if("string"==typeof e&&(e=parseInt(e,10)),void 0===this.RaceInfo)return null;var t=this.RaceInfo.races_waypoints[e];do{if("string"==typeof t&&(t=parseInt(t,10)),t.wpformat&WP_ICE_GATE){if(++e>=this.RaceInfo.races_waypoints)throw"Oops could not find requested gate type";t=this.RaceInfo.races_waypoints[e]}}while(t.wpformat&WP_ICE_GATE);var a=new VLMPosition(t.longitude1,t.latitude1);if((t.format&WP_GATE_BUOY_MASK)!==WP_TWO_BUOYS)throw"not implemented 1 buoy gate";return{P1:a,P2:new VLMPosition(t.longitude2,t.latitude2)}},this.GetClosestEstimatePoint=function(e){if(void 0===e||!e)return this.Estimator&&this.Estimator.ClearEstimatePosition(this.Estimator.Boat),null;if(this.Estimator){var t=this.Estimator.GetClosestEstimatePoint(e);return t?this.Estimator.ShowEstimatePosition(this.Estimator.Boat,t):this.Estimator.ClearEstimatePosition(this.Estimator.Boat),t}return null},this.GetNextWPPosition=function(e,t,a){if(void 0===this.VLMInfo)return null;this.VLMInfo.NWP;if(!(void 0!==a&&a||"0"===this.VLMInfo.WPLON&&"0"===this.VLMInfo.WPLAT))return new VLMPosition(this.VLMInfo.WPLON,this.VLMInfo.WPLAT);if(void 0!==a&&a&&0!==a.Lon.Value&&0!==a.Lat.Value)return new VLMPosition(a.Lon.Value,a.Lat.Value);var n=this.VLMInfo.NWP;void 0!==e&&e&&(n=e);var o=this.GetNextGateSegment(n);if(void 0===o||!o)return null;var i,r=o.P1.GetLoxoCourse(o.P2);i=void 0!==t&&t?t:new VLMPosition(this.VLMInfo.LON,this.VLMInfo.LAT);var s=r-o.P1.GetLoxoCourse(i);if(s>180?s-=360:s<-180&&(s+=360),(s=Math.abs(s))>90)return o.P1;var l=o.P1.GetLoxoDist(i);try{var u=l*Math.cos(Deg2Rad(s));return o.P1.GetLoxoDist(o.P2)>u?o.P1.ReachDistLoxo(u,r):o.P2}catch(e){return null}}}function User(){this.IdPlayer=-1,this.IsAdmin=!1,this.PlayerName="",this.PlayerJID="",this.Fleet=[],this.BSFleet=[],this.CurBoat={},this.LastLogin=0,this.KeepAlive=function(){console.log("Keeping login alive..."),CheckLogin()},setInterval(this.KeepAlive,6e5)}function IsLoggedIn(){return _IsLoggedIn}function OnLoginRequest(){CheckLogin(!0)}function GetPHPSessId(){var e,t=document.cookie.split(";");for(e in t)if(t[e]){var a=t[e].split("=");if(a[0]&&"PHPSESSID"===a[0].trim())return a[0]}return null}function CheckLogin(e){var t=$(".UserName").val(),a=$(".UserPassword").val();GetPHPSessId()||"string"==typeof t&&"string"==typeof a&&t.trim().length>0&&a.trim().length>0?(ShowPb("#PbLoginProgress"),$.post("/ws/login.php",{VLM_AUTH_USER:t.trim(),VLM_AUTH_PW:a.trim()},function(t){var a=JSON.parse(t),n=null;_IsLoggedIn&&(n=_CurPlayer.CurBoatID),_IsLoggedIn=!0===a.success,HandleCheckLoginResponse(e),n&&SetCurrentBoat(GetBoatFromIdu(select),!1)})):HandleCheckLoginResponse(e)}function HandleCheckLoginResponse(e){_IsLoggedIn?GetPlayerInfo():e&&(VLMAlertDanger(GetLocalizedString("authfailed")),$(".UserPassword").val(""),setTimeout(function(){$("#LoginForm").modal("hide").modal("show")},1e3),initrecaptcha(!0,!1),$("#ResetPasswordLink").removeClass("hidden")),HidePb("#PbLoginProgress"),DisplayLoggedInMenus(_IsLoggedIn)}function Logout(){DisplayLoggedInMenus(!1),$.post("/ws/logout.php",function(e){e.success?window.location.reload():(VLMAlertDanger("Something bad happened while logging out. Restart browser..."),windows.location.reload())}),_IsLoggedIn=!1}var _CurPlayer=null;function GetPlayerInfo(){ShowBgLoad(),$.get("/ws/playerinfo/profile.php",function(e){e.success?(void 0!==_CurPlayer&&_CurPlayer||(_CurPlayer=new User),_CurPlayer.IdPlayer=e.profile.idp,_CurPlayer.IsAdmin=e.profile.admin,_CurPlayer.PlayerName=e.profile.playername,$.get("/ws/playerinfo/fleet_private.php",HandleFleetInfoLoaded),RefreshPlayerMenu()):Logout()})}function HandleFleetInfoLoaded(e){var t;for(var a in void 0===_CurPlayer&&(_CurPlayer=new User),void 0===_CurPlayer.Fleet&&(_CurPlayer.Fleet=[]),e.fleet)void 0===_CurPlayer.Fleet[a]&&(_CurPlayer.Fleet[a]=new Boat(e.fleet[a]),void 0===t&&(t=_CurPlayer.Fleet[a]));for(var n in void 0===_CurPlayer.fleet_boatsit&&(_CurPlayer.fleet_boatsit=[]),e.fleet_boatsit)void 0===_CurPlayer.BSFleet[n]&&(_CurPlayer.BSFleet[n]=new Boat(e.fleet_boatsit[n]));RefreshPlayerMenu(),void 0!==t&&t&&(DisplayCurrentDDSelectedBoat(t),SetCurrentBoat(GetBoatFromIdu(t),!0),RefreshCurrentBoat(!0,!1))}function RefreshPlayerMenu(){for(var e in $("#PlayerId").text(_CurPlayer.PlayerName),ClearBoatSelector(),_CurPlayer.Fleet)AddBoatToSelector(_CurPlayer.Fleet[e],!0);for(var t in _CurPlayer.BSFleet)_CurPlayer.BSFleet[t]&&AddBoatToSelector(_CurPlayer.BSFleet[t],!1);DisplayLoggedInMenus(!0),HideBgLoad("#PbLoginProgress")}function SetupUserMenu(){var e=$(document).width()/2-$(".UserMenu").width()/2+"px";$(".UserMenu").show(),$(".UserMenu").animate({left:e,top:0},0)}function GetBoatFromIdu(e){if(void 0!==_CurPlayer){var t=GetBoatFromBoatArray(_CurPlayer.Fleet,e);return void 0===t&&(t=GetBoatFromBoatArray(_CurPlayer.BSFleet,e)),t}}function GetBoatFromBoatArray(e,t){for(var a in t=parseInt(t,10),e)if(e[a]&&e[a].IdBoat===t)return e[a]}function GetFlagsList(){$.get("/ws/serverinfo/flags.php",function(e){if(e.success){var t=$("#CountryDropDownList"),a=0;for(var n in e.flags)if(e.flags[n]){var o=e.flags[n];t.append("<li class='FlagLine DDLine' flag='"+o+"'>"+GetCountryDropDownSelectorHTML(o,!0,a++)+"</li>")}}$(".FlagLine").on("click",HandleFlagLineClick)})}var FlagsIndexCache=[];function GetCountryDropDownSelectorHTML(e,t,a){if(t){var n=GetCountryFlagImg(e,a);FlagsIndexCache[e]=n}var o=" <span  class='FlagLabel' flag='"+e+"'> - "+e+"</span>";return FlagsIndexCache[e]+o}function GetCountryFlagImgHTML(e){return FlagsIndexCache[e]}function GetCountryFlagImg(e,t){return" <div class='FlagIcon' style='background-position: -"+t%16*30+"px -"+20*Math.floor(t/16)+"px' flag='"+e+"'></div>"}var VLM_COORDS_FACTOR=1e3,OppPopups=[],StartSetWPOnClick=!1;function SetCurrentBoat(e,t,a,n){_CurPlayer&&_CurPlayer.CurBoat&&e&&(_CurPlayer.CurBoat.IdBoat!==e.IdBoat&&ClearCurrentMapMarker(_CurPlayer.CurBoat),EnsureMarkersVisible(e)),CheckBoatRefreshRequired(e,t,a,n)}var BoatLoading=new Date(0);function CheckBoatRefreshRequired(e,t,a,n){if(void 0!==e&&e){var o=new Date,i=void 0!==e&&(void 0===e.VLMInfo||void 0===e.VLMInfo.AVG);UpdatePrefsDialog(e),void 0!==e.VLMInfo&&void 0!==e.VLMInfo.LUP||(a=!0),a||o>=e.NextServerRequestDate?(BoatLoading=o+3e3,console.log("Loading boat info from server...."),ShowPb("#PbGetBoatProgress"),$.get("/ws/boatinfo.php?forcefmt=json&select_idu="+e.IdBoat,function(a){if(e.IdBoat===parseInt(a.IDU,10)){_CurPlayer.CurBoat=e,LoadVLMPrefs(),e.VLMInfo=a,e.NextServerRequestDate=new Date(1e3*(parseInt(e.VLMInfo.LUP,10)+parseInt(e.VLMInfo.VAC,10))),e.LastRefresh=new Date,e.VLMInfo.LON/=VLM_COORDS_FACTOR,e.VLMInfo.LAT/=VLM_COORDS_FACTOR,console.log("DBG WIND ");var o=GribMgr.WindAtPointInTime(new Date(1566149443e3),49.753227868452,-8.9971082951315);if(o){var r=o.Heading+40,s=PolarsManager.GetBoatSpeed("boat_figaro2",o.Speed,o.Heading,r);if(!isNaN(s))new VLMPosition(49.753227868452,-8.9971082951315).ReachDistLoxo(s/3600*300,r)}i&&UpdatePrefsDialog(e),"0"!==e.VLMInfo.RAC?(void 0===e.RaceInfo||void 0===e.RaceInfo.idraces?(GetRaceInfoFromServer(e,n),GetRaceExclusionsFromServer(e)):(DrawRaceGates(e),DrawRaceExclusionZones(e.Exclusions)),GetTrackFromServer(e),e.VLMInfo&&e.VLMInfo.RAC&&LoadRankings(e.VLMInfo.RAC),LoadRealsList(e),DrawBoat(e,t),UpdateInMenuRacingBoatInfo(e,n)):UpdateInMenuDockingBoatInfo(e)}HidePb("#PbGetBoatProgress"),OnPlayerLoadedCallBack&&(OnPlayerLoadedCallBack(),OnPlayerLoadedCallBack=null)})):e&&(UpdateInMenuDockingBoatInfo(e),UpdateInMenuRacingBoatInfo(e,n),DrawBoat(e,t),DrawRaceGates(e),DrawRaceExclusionZones(e.Exclusions))}}function GetTrackFromServer(e){var t=Math.floor(new Date/1e3),a=t-86400;$.get("/ws/boatinfo/tracks_private.php?idu="+e.IdBoat+"&idr="+e.VLMInfo.RAC+"&starttime="+a+"&endtime="+t,function(t){if(t.success){for(var a in void 0!==e.Track?e.Track.length=0:e.Track=[],t.tracks)if(t.tracks[a]){var n=new VLMPosition(t.tracks[a][1]/1e3,t.tracks[a][2]/1e3);e.Track.push(n)}DrawBoat(e)}})}function GetRaceExclusionsFromServer(e){$.get("/ws/raceinfo/exclusions.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(t){if(t.success){var a,n,o=[],i=[];for(n in t.Exclusions)if(t.Exclusions[n]){var r=t.Exclusions[n];(void 0===a||a[0]!==r[0][0]&&a[1]!==r[0][1])&&(void 0!==a&&(o.push(i),i=[]),i.push(r[0])),a=r[1],i.push(r[1])}o.push(i),e.Exclusions=o,DrawRaceExclusionZones(o)}})}function GetRaceInfoFromServer(e,t){$.get("/ws/raceinfo/desc.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(a){e.RaceInfo=a,DrawRaceGates(e),UpdateInMenuRacingBoatInfo(e,t)})}var DrawBoatTimeOutHandle=null,DeferredCenterValue=!1;function DrawBoat(e,t){void 0!==t&&(DeferredCenterValue=DeferredCenterValue||t),console.log("Call DrawbBoat ("+t+") deferred : "+DeferredCenterValue),DrawBoatTimeOutHandle&&(console.log("Pushed DrawBoat"),clearTimeout(DrawBoatTimeOutHandle)),DrawBoatTimeOutHandle=setTimeout(ActualDrawBoat,100,e,DeferredCenterValue)}function GetRaceMapFeatures(e){if(!e)throw"Should not GetRaceFeature unless a boat is defined";return void 0===e.RaceMapFeatures&&(e.RaceMapFeatures={}),e.RaceMapFeatures}function ActualDrawBoat(e,t){map.zoom;if(DeferredCenterValue=!1,DrawBoatTimeOutHandle=null,void 0===e||!e){if(void 0===_CurPlayer||!_CurPlayer||void 0===_CurPlayer.CurBoat||!_CurPlayer.CurBoat)return;e=_CurPlayer.CurBoat}if(void 0!==e&&e){var a=GetRaceMapFeatures(e),n=a.TrackWP,o=null;if(void 0!==e&&e&&(o=e.GetNextWPPosition()),void 0!==o&&o)if(n)n.setLatLng([o.Lat.Value,o.Lon.Value]);else{var i=GetTrackWPMarker();a.TrackWP=L.marker([o.Lat.Value,o.Lon.Value],{icon:i}).addTo(map)}if(void 0!==_typeof(e.VLMInfo)&&e.VLMInfo&&(e.VLMInfo.LON||e.VLMInfo.LAT)){var r=a.BoatMarker;r?(r.setLatLng([e.VLMInfo.LAT,e.VLMInfo.LON]),r.setRotationAngle(e.VLMInfo.HDG)):(r=GetBoatMarker(),a.BoatMarker=L.marker([e.VLMInfo.LAT,e.VLMInfo.LON],{icon:r,rotationAngle:e.VLMInfo.HDG}).addTo(map));PolarsManager.GetPolarLine(e.VLMInfo.POL,e.VLMInfo.TWS,DrawBoat,e)}if(void 0!==e.Track&&e.Track.length>0){for(var s=[],l=e.Track.length,u=0;u<l;u++){var d=e.Track[u];s.push([d.Lat.Value,d.Lon.Value])}var c=e.VLMInfo.COL;"#"!==c[0]&&(c="#"+c);var p=a.BoatTrack;p?p.setLatLngs(s):a.BoatTrack=L.polyline(s,{type:"HistoryTrack",color:c,weight:1.2}).addTo(map)}if(void 0!==e.Estimator&&e.Estimator){var h=e.Estimator.GetEstimateTracks(),P=["green","orange","red"];for(var f in h)if(a.EstimateTracks&&a.EstimateTracks[f])void 0!==h[f]?a.EstimateTracks[f].setLatLngs(h[f]):(a.EstimateTracks[f].remove(),a.EstimateTracks[f]=null);else if(void 0===a.EstimateTracks&&(a.EstimateTracks=[]),h[f]){var g={weight:2,opacity:1,color:P[f]};a.EstimateTracks[f]=L.polyline(h[f],g).addTo(map)}}if(DrawOpponents(e),void 0!==e.OppTrack&&Object.keys(e.OppTrack).length>0)for(var M in e.OppTrack){var m=e.OppTrack[M];if(m&&m.Visible&&m.DatePos.length>1){if(!m.OLTrackLine){for(var I=[],C=Object.keys(m.DatePos).length,v=0;v<C;v++){var R=Object.keys(m.DatePos)[v],S=m.DatePos[R],_=new OpenLayers.Geometry.Point(S.lon,S.lat).transform(MapOptions.displayProjection,MapOptions.projection);I.push(_)}m.OLTrackLine=I}var k=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(m.OLTrackLine),{type:"HistoryTrack",TrackColor:m.TrackColor});m.LastShow=new Date,VLMBoatsLayer.addFeatures(k),BoatFeatures.push(k)}}t&&void 0!==e.VLMInfo&&e.VLMInfo&&void 0!==map&&map&&map.setView([e.VLMInfo.LAT,e.VLMInfo.LON]),console.log("ActualDrawBoatComplete")}}function BuildPolarLine(e,t,a,n,o,i,r){var s=i;e&&e.VLMInfo&&e.VLMInfo.VAC&&(s-=1e3*e.VLMInfo.VAC),(!s||s<(new Date).getTime())&&(s=(new Date).getTime());var l=GribMgr.WindAtPointInTime(s,n.Lat.Value,n.Lon.Value,r);if(l){var u;parseFloat(e.VLMInfo.HDG);for(u=0;u<=180;u+=5){var d,c=PolarsManager.GetBoatSpeed(e.VLMInfo.POL,l.Speed,l.Heading,l.Heading+u);if(isNaN(c))return;for(d=-1;d<=1;d+=2){var p=n.ReachDistLoxo(c/3600*e.VLMInfo.VAC*o,l.Heading+u*d),h=new OpenLayers.Geometry.Point(p.Lon.Value,p.Lat.Value).transform(MapOptions.displayProjection,MapOptions.projection);a[180+d*u]=h}}}}function GetVLMPositionFromClick(e){if(map){var t=map.getLonLatFromPixel(e).transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));return new VLMPosition(t.lon,t.lat)}return null}function CompleteWPSetPosition(e,t){var a=GetVLMPositionFromClick(t);console.log("DragComplete "+e.id),VLMBoatsLayer.removeFeatures(e),SendVLMBoatWPPos(_CurPlayer.CurBoat,a)}var WP_TWO_BUOYS=0,WP_ONE_BUOY=1,WP_GATE_BUOY_MASK=15,WP_DEFAULT=0,WP_ICE_GATE_N=16,WP_ICE_GATE_S=32,WP_ICE_GATE_E=64,WP_ICE_GATE_W=128,WP_ICE_GATE=WP_ICE_GATE_E|WP_ICE_GATE_N|WP_ICE_GATE_S|WP_ICE_GATE_W,WP_GATE_KIND_MASK=65520,WP_CROSS_CLOCKWISE=256,WP_CROSS_ANTI_CLOCKWISE=512,WP_CROSS_ONCE=1024,Exclusions=[];function DrawRaceGates(e){if(void 0!==e&&e&&e.RaceInfo){var t=e.RaceInfo,a=e.VLMInfo.NWP,n=GetRaceMapFeatures(e);if(void 0!==_typeof(t)&&t&&void 0!==t.races_waypoints&&t.races_waypoints)for(var o in t.races_waypoints){n.Gates||(n.Gates=[]),n.Gates[o]||(n.Gates[o]={});var i=n.Gates[o];if(t.races_waypoints[o]){var r=i.Buoy1,s=t.races_waypoints[o];NormalizeRaceInfo(t);var l=!(s.wpformat&WP_CROSS_ANTI_CLOCKWISE),u=new VLMPosition(s.longitude1,s.latitude1);if(i.Buoy1=AddBuoyMarker(r,"WP"+o+" "+s.libelle+"<BR>"+u.toString(),s.longitude1,s.latitude1,l),(s.wpformat&WP_GATE_BUOY_MASK)===WP_TWO_BUOYS){var d=i.Buoy2,c=new VLMPosition(s.longitude2,s.latitude2);i.Buoy2=AddBuoyMarker(d,"WP"+o+" "+s.libelle+"<BR>"+c.toString(),s.longitude2,s.latitude2,!l)}else{for(var p=new VLMPosition(s.longitude1,s.latitude1),h=!1,P=2500,f=null;!h;)try{f=p.ReachDistLoxo(P,180+parseFloat(s.laisser_au)),h=!0}catch(e){P*=.7}s.longitude2=f.Lon.Value,s.latitude2=f.Lat.Value}o=parseInt(o,10),a=parseInt(a,10),AddGateSegment(i,s.longitude1,s.latitude1,s.longitude2,s.latitude2,a===o,o<a,s.wpformat&WP_GATE_KIND_MASK)}}}}function DrawRaceExclusionZones(e){}function DrawRaceExclusionZone(e,t,a){var n,o=[],i=!1;for(n in a)if(a[n]){var r=new OpenLayers.Geometry.Point(a[n][1],a[n][0]).transform(MapOptions.displayProjection,MapOptions.projection);o.push(r),i=!0}if(i){var s;s={type:"ExclusionZone"};var l=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(o)),s,null);e.addFeatures(l),t.push(l)}}function GetLonOffset(e,t){return e*t>=0?0:Math.abs(t-e)>90?e>0?360:-360:0}function AddGateSegment(e,t,a,n,o,i,r,s){var l=[[a,t],[o,n]],u="";if(u=i?"green":r?"blue":"red",s&WP_CROSS_ONCE&&(e.Segment2?e.Segment2.setLatLngs(l):e.Segment2=L.polyline(l,{color:"black",dashArray:"20,10,5,10",weight:2,opacity:.75}).addTo(map)),e.Segment?(e.Segment.setLatLngs(l),e.Segment.color=u):e.Segment=L.polyline(l,{color:u,weight:1,opacity:.75}).addTo(map),s!==WP_DEFAULT){var d=new VLMPosition(t,a),c=new VLMPosition(n,o),p=d.GetLoxoCourse(c),h=d.ReachDistLoxo(c,.5);s&WP_CROSS_ANTI_CLOCKWISE?(p-=90,AddGateDirMarker(e,h.Lon.Value,h.Lat.Value,p)):s&WP_CROSS_CLOCKWISE?(p+=90,AddGateDirMarker(e,h.Lon.Value,h.Lat.Value,p)):s&WP_ICE_GATE&&AddGateIceGateMarker(e,h.Lon.Value,h.Lat.Value)}}var MAX_BUOY_INDEX=16,BuoyIndex=Math.floor(Math.random()*MAX_BUOY_INDEX);function AddGateDirMarker(e,t,a,n){AddGateCenterMarker(e,t,a,"BuoyDirs/BuoyDir"+BuoyIndex+".png",n,!1),BuoyIndex++,BuoyIndex%=MAX_BUOY_INDEX+1}function AddGateIceGateMarker(e,t,a){AddGateCenterMarker(e,t,a,"icegate.png",!0)}function AddGateCenterMarker(e,t,a,n,o,i){var r=[a,t];if(e.GateMarker)e.GateMarker.setLatLng(r);else{var s=GetGateTypeMarker(n,i);e.GateMarker=L.marker(r,{icon:s}).addTo(map),i||e.GateMarker.setRotationAngle(o)}}function AddBuoyMarker(e,t,a,n,o){var i=GetBuoyMarker(o);if(e){if(e.IsCWBuoy===o)return e.setLatLng([n,a]);e.remove()}return L.marker([n,a],{icon:i}).addTo(map).bindPopup(t)}var PM_HEADING=1,PM_ANGLE=2,PM_ORTHO=3,PM_VMG=4,PM_VBVMG=5;function SendVLMBoatWPPos(e,t){var a={idu:e.IdBoat,pip:{targetlat:t.Lat.Value,targetlong:t.Lon.Value,targetandhdg:-1}};PostBoatSetupOrder(e.IdBoat,"target_set",a)}function SendVLMBoatOrder(e,t,a,n){var o={};if(void 0!==_CurPlayer&&void 0!==_CurPlayer.CurBoat){switch(e){case PM_HEADING:case PM_ANGLE:o={idu:_CurPlayer.CurBoat.IdBoat,pim:e,pip:t};break;case PM_ORTHO:case PM_VBVMG:case PM_VMG:o={idu:_CurPlayer.CurBoat.IdBoat,pim:e,pip:{targetlong:parseFloat(t),targetlat:parseFloat(a),targetandhdg:n}};break;default:return}PostBoatSetupOrder(_CurPlayer.CurBoat.IdBoat,"pilot_set",o)}else VLMAlertDanger("Must select a boat to send an order")}function PostBoatSetupOrder(e,t,a){$.post("/ws/boatsetup/"+t+".php?selectidu"+e,"parms="+JSON.stringify(a),function(e,t){e.success?RefreshCurrentBoat(!1,!0):VLMAlertDanger(GetLocalizedString("BoatSetupError")+"\n"+e.error.code+" "+e.error.msg)})}function EngageBoatInRace(e,t){$.post("/ws/boatsetup/race_subscribe.php","parms="+JSON.stringify({idu:t,idr:parseInt(e,10)}),function(e){if(e.success){var t=GetLocalizedString("youengaged");$("#RacesListForm").modal("hide"),VLMAlertSuccess(t)}else{VLMAlertDanger(e.error.msg+"\n"+e.error.custom_error_string)}})}function DiconstinueRace(e,t){$.post("/ws/boatsetup/race_unsubscribe.php","parms="+JSON.stringify({idu:e,idr:parseInt(t,10)}),function(e){e.success?VLMAlertSuccess("Bye Bye!"):VLMAlertDanger(e.error.msg+"\n"+e.error.custom_error_string)})}function HandleMapZoomEnd(e,t){var a=VLMBoatsLayer.getZoomForResolution(VLMBoatsLayer.getResolution());VLM2Prefs.MapPrefs.MapZoomLevel=a,VLM2Prefs.Save(),RefreshCurrentBoat(!1)}function LoadRealsList(e){void 0!==e&&e&&void 0!==e.VLMInfo&&$.get("/ws/realinfo/realranking.php?idr="+e.VLMInfo.RAC,function(t){t.success?(e.Reals=t,DrawBoat(e,!1)):e.Reals=[]})}function LoadRankings(e,t){e&&"object"===_typeof(e)&&VLMAlertDanger("Not updated call to LoadRankings"),$.get("/cache/rankings/rnk_"+e+".json",function(a){a?(Rankings[e]=a.Boats,t?t():DrawBoat(null,!1)):Rankings[e]=null})}function contains(e,t){for(var a=0;a<e.length;a++)if(e[a]===t)return!0;return!1}function DrawOpponents(e){if(e&&void 0!==Rankings){var t,a=[];if(VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowSel&&(void 0!==e.VLMInfo&&void 0!==e.VLMInfo.MPO&&(a=e.VLMInfo.MPO.split(",")),0!==a.length)){var n=e.VLMInfo.RAC;for(t in a)if(a[t]&&Rankings[n]){var o=Rankings[n][a[t]];void 0!==o&&parseInt(o.idusers,10)!==e.IdBoat&&AddOpponent(e,VLMBoatsLayer,BoatFeatures,o,!0)}}if(VLM2Prefs.MapPrefs.ShowReals&&void 0!==e.Reals&&void 0!==e.Reals.ranking)for(t in e.Reals.ranking){var i=e.Reals.ranking[t];AddOpponent(e,VLMBoatsLayer,BoatFeatures,i,!0)}var r=150,s=r/Object.keys(Rankings).length,l=0,u=Rankings;switch(void 0!==e.OppList&&e.OppList.length>0&&(u=e.OppList,s=1),VLM2Prefs.MapPrefs.MapOppShow){case VLM2Prefs.MapPrefs.MapOppShowOptions.Show10Around:u=GetClosestOpps(e,10),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.Show5Around:u=GetClosestOpps(e,5),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTop10:var d=0,c=e.Engaged;for(t in r=VLM2Prefs.MapPrefs.ShowTopCount,u=[],Rankings[c])if(Rankings[c][t].rank<=VLM2Prefs.MapPrefs.ShowTopCount&&(u[t]=Rankings[c][t],++d>r))break;d>r&&(r=d),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowMineOnly:u=[],s=1}if(SortRankingData(e,"RAC",null,e.Engaged),e.Engaged&&void 0!==Rankings[e.Engaged]&&void 0!==Rankings[e.Engaged].RacerRanking&&Rankings[e.Engaged].RacerRanking){var p=GetRaceMapFeatures(e);for(t in Rankings[e.Engaged].RacerRanking)if(t in Rankings[e.Engaged].RacerRanking){var h=Rankings[e.Engaged].RacerRanking[t];if(parseInt(h.idusers,10)!==e.IdBoat&&u[h.idusers]&&!contains(a,h.idusers)&&RnkIsRacing(h)&&Math.random()<=s&&l<r)AddOpponent(e,p,h,!1),l+=1,void 0===e.OppList&&(e.OppList=[]),e.OppList[t]=h;else if(l>=r)break}}}}function CompareDist(e,t){return e.dnm<t.dnm?-1:e.dnm>t.dnm?1:0}function GetClosestOpps(e,t){var a=null;e&&e.VLMInfo&&(a=e.VLMInfo.RAC);var n=[];if(a&&Rankings[a]){var o=Rankings[a][e.IdBoat];void 0!==o&&e||(o={dnm:0,nwp:1});var i=parseFloat(o.dnm),r=o.nwp,s=[];for(var l in Rankings[a])if(Rankings[a][l]&&r===Rankings[a][l].nwp){var u={id:l,dnm:Math.abs(i-parseFloat(Rankings[a][l].dnm))};s.push(u)}for(var d in(s=s.sort(CompareDist)).slice(0,t-1))n[s[d].id]=Rankings[a][s[d].id]}return n}function AddOpponent(e,t,a,n){var o=[a.latitude,a.longitude],i=map.getZoom(),r={name:a.idusers,Coords:new VLMPosition(a.longitude,a.latitude).toString(),type:"opponent",idboat:a.idusers,rank:a.rank,Last1h:a.last1h,Last3h:a.last3h,Last24h:a.last24h,IsTeam:a.country==e.VLMInfo.CNT?"team":"",IsFriend:n?2*i:i,color:a.color};if(VLM2Prefs.MapPrefs.ShowOppNumbers||(r.name=""),void 0===t.Opponents&&(t.Opponents=[]),t.Opponents[a.idusers])t.Opponents[a.idusers].setLatLng(o);else{var s=GetOpponentMarker(r);t.Opponents[a.idusers]=L.marker(o,{icon:s}).addTo(map)}}function ShowOpponentPopupInfo(e){if("opponent"==e.feature.data.type){var t=GetOppBoat(e.feature.attributes.idboat);if(t){var a=new VLMPosition(t.longitude,t.latitude),n=[],o=e.feature;OppPopups[e.feature.attributes.idboat]&&(map.removePopup(OppPopups[e.feature.attributes.idboat]),OppPopups[e.feature.attributes.idboat]=null);var i=new OpenLayers.Popup.FramedCloud("popup",OpenLayers.LonLat.fromString(o.geometry.toShortString()),null,BuildBoatPopupInfo(t),null,!0,null);i.autoSize=!0,i.maxSize=new OpenLayers.Size(400,800),i.fixedRelativePosition=!0,o.popup=i,map.addPopup(i),OppPopups[e.feature.attributes.idboat]=i,n.push([FIELD_MAPPING_TEXT,"#__BoatName"+e.feature.attributes.idboat,t.boatname]),n.push([FIELD_MAPPING_TEXT,"#__BoatId"+e.feature.attributes.idboat,e.feature.attributes.idboat]),n.push([FIELD_MAPPING_TEXT,"#__BoatRank"+e.feature.attributes.idboat,e.feature.attributes.rank]),n.push([FIELD_MAPPING_TEXT,"#__BoatLoch"+e.feature.attributes.idboat,RoundPow(parseFloat(t.loch),2)]),n.push([FIELD_MAPPING_TEXT,"#__BoatNWP"+e.feature.attributes.idboat,"["+t.nwp+"] "+RoundPow(parseFloat(t.dnm),2)]),n.push([FIELD_MAPPING_TEXT,"#__BoatPosition"+e.feature.attributes.idboat,a.GetVLMString()]),n.push([FIELD_MAPPING_TEXT,"#__Boat1HAvg"+e.feature.attributes.idboat,RoundPow(parseFloat(t.last1h),2)]),n.push([FIELD_MAPPING_TEXT,"#__Boat3HAvg"+e.feature.attributes.idboat,RoundPow(parseFloat(t.last3h),2)]),n.push([FIELD_MAPPING_TEXT,"#__Boat24HAvg"+e.feature.attributes.idboat,RoundPow(parseFloat(t.last24h),2)]),FillFieldsFromMappingTable(n)}}}function GetOppBoat(e){var t=_CurPlayer.CurBoat;if(void 0!==t&&t&&t.OppList){for(var a in t.OppList)if(t.OppList[a]){var n=t.OppList[a];if(n.idusers===e)return n}if(t.Reals&&t.Reals.ranking)for(var o in t.Reals.ranking)if(t.Reals.ranking[o]){var i=t.Reals.ranking[o];if(i.idusers===e)return i}}return null}function BuildBoatPopupInfo(e){var t=e.idusers;return'<div class="MapPopup_InfoHeader">'+GetCountryFlagImgHTML(e.country)+' <span id="__BoatName'+t+'" class="PopupBoatNameNumber ">BoatName</span> <span id="__BoatId'+t+'" class="PopupBoatNameNumber ">BoatNumber</span> <div id="__BoatRank'+t+'" class="TxtRank">Rank</div></div><div class="MapPopup_InfoBody"> <fieldset>   <span class="PopupHeadText " I18n="loch">'+GetLocalizedString("loch")+'</span><span class="PopupText"> : </span><span id="__BoatLoch'+t+'" class="loch PopupText">0.9563544</span>   <BR><span class="PopupHeadText " I18n="position">'+GetLocalizedString("position")+'</span><span class="PopupText"> : </span><span id="__BoatPosition'+t+'" class=" PopupText">0.9563544</span>   <BR><span class="PopupHeadText " I18n="NextWP">'+GetLocalizedString("NextWP")+'</span><span class="strong"> : </span><span id="__BoatNWP'+t+'" class="PopupText">[1] 4.531856536865234</span>   <BR><span class="PopupHeadText " I18n="Moyennes">'+GetLocalizedString("Moyennes")+' </span><span class="PopupText"> : </span>   <span class="PopupHeadText ">[1h]</span><span id="__Boat1HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>   <span class="PopupHeadText ">[3h]</span><span id="__Boat3HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>   <span class="PopupHeadText ">[24h]</span><span id="__Boat24HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span> </fieldset></div>'}function HandleFeatureOver(e){var t;if("opponent"==e.feature.data.type){for(t in _CurPlayer.CurBoat.OppTrack)_CurPlayer.CurBoat.OppTrack[t].Visible=!1;DrawOpponentTrack(e.feature.data)}}function HandleFeatureClick(e){HandleFeatureOver(e),ShowOpponentPopupInfo(e)}function HandleFeatureOut(e){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.OppTrack)for(var t in _CurPlayer.CurBoat.OppTrack)_CurPlayer.CurBoat.OppTrack[t].Visible=!1}var TrackPendingRequests=[],LastTrackRequest=0;function DrawOpponentTrack(e){var t=_CurPlayer.CurBoat,a=e.idboat,n=new Date,o=null;if(void 0!==t&&t&&n>LastTrackRequest){if(LastTrackRequest=new Date(n/1e3+.5),void 0!==t.OppTrack||!(a in t.OppTrack)||a in t.OppTrack&&t.OppTrack[a].LastShow<=new Date(1e3*t.VLMInfo.LUP)){var i=new Date/1e3-172800,r=t.VLMInfo.RAC,s=new Date;o=a.toString()+"/"+r.toString(),a in t.OppTrack&&(t.OppTrack[a].Visible=!0),o in TrackPendingRequests&&!(s>TrackPendingRequests[o])||(TrackPendingRequests[o]=new Date(s.getTime()+6e4),console.log("GetTrack "+o+" "+i),parseInt(a)>0?GetBoatTrack(t,a,r,i,e):parseInt(a)&&GetRealBoatTrack(t,a,r,i,e))}else console.log(" GetTrack ignore before next update"+o+" "+StartTime);DrawBoat(t)}}function GetRealBoatTrack(e,t,a,n,o){$.get("/ws/realinfo/tracks.php?idr="+a+"&idreals="+-t+"&starttime="+n,function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,o.color),RefreshCurrentBoat(!1,!1))})}var TrackRequestPending=!1;function GetBoatTrack(e,t,a,n,o){TrackRequestPending||(TrackRequestPending=!0,$.get("/ws/boatinfo/smarttracks.php?idu="+t+"&idr="+a+"&starttime="+n,function(a){if(TrackRequestPending=!1,a.success){var n;for(n in AddBoatOppTrackPoints(e,t,a.tracks,o.color),a.tracks_url){if(n>10)break;$.get("/cache/tracks/"+a.tracks_url[n],function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,o.color),RefreshCurrentBoat(!1,!1))})}RefreshCurrentBoat(!1,!1)}}))}function AddBoatOppTrackPoints(e,t,a,n){for(var o in t in e.OppTrack||(n=SafeHTMLColor(n),e.OppTrack[t]={LastShow:0,TrackColor:n,DatePos:[],Visible:!0,OLTrackLine:null}),a){var i=a[o];e.OppTrack[t].DatePos[i[0]]={lat:i[2]/1e3,lon:i[1]/1e3}}e.OppTrack[t].LastShow=0,e.OppTrack[t].OLTrackLine=null}function DeletePilotOrder(e,t){$.post("/ws/boatsetup/pilototo_delete.php?","parms="+JSON.stringify({idu:e.IdBoat,taskid:parseInt(t)}),function(e){e.success&&RefreshCurrentBoat(!1,!0,"AutoPilot")})}function UpdateBoatPrefs(e,t){t.idu=e.IdBoat,$.post("/ws/boatsetup/prefs_set.php","parms="+JSON.stringify(t),function(e){e.success?RefreshCurrentBoat(!1,!1):VLMAlertDanger(GetLocalizedString("UpdateFailed"))})}function LoadVLMPrefs(){var e;void 0!==_CurPlayer&&(e=_CurPlayer.CurBoat,SetDDTheme(VLM2Prefs.CurTheme),$.get("/ws/boatinfo/prefs.php?idu="+e.IdBoat,HandlePrefsLoaded))}function HandlePrefsLoaded(e){e.success?(_CurPlayer.CurBoat.VLMPrefs=e.prefs,VLM2Prefs.UpdateVLMPrefs(e.prefs)):VLMAlertDanger("Error communicating with VLM, try reloading the browser page...")}function InitXmpp(){converse.initialize({bosh_service_url:"https://bind.conversejs.org",i18n:locales.en,show_controlbox_by_default:!0,roster_groups:!0})}